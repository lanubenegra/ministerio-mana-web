---
interface IdentitySection {
  id: string;
  title: string;
  subtitle?: string;
  content: string[];
  highlight?: string;
  rotate: string; // Globe rotation
  pin?: { x: number; y: number; angle: number; len: number; label: string };
}

const cspNonce = Astro.locals?.cspNonce;

const sections: IdentitySection[] = [
  {
    id: 'intro',
    title: 'Es momento de',
    highlight: 'ORAR AGRADECER',
    content: [],
    rotate: '0deg', // Default
  },
  {
    id: 'mision',
    title: 'Nuestra Misión',
    content: [
      'Somos una iglesia que enseña las Escrituras, edificando las vidas de los hijos de Dios a través de hábitos espirituales que los lleven a conocer, amar y obedecer a Dios, con un alto grado de compromiso en el servicio ministerial para dar cumplimiento al plan de Dios.',
      'Formamos hombres y mujeres de Dios que guiados por el Espíritu Santo lleguen a ser sus instrumentos en el establecimiento de grupos pequeños e iglesias locales que impacten su entorno cercano y el mundo.',
    ],
    rotate: '-15deg',
  },
  {
    id: 'vision',
    title: 'Nuestra Visión',
    highlight: '2030',
    content: [
      'Ser una iglesia bíblica, cristocéntrica y relevante en su entorno, con presencia nacional e internacional en el 2030.',
      'Una iglesia que discipula a quienes han nacido de nuevo, que predica el evangelio como un estilo de vida a través de todos los medios posibles, enseñando a amar a Dios genuinamente y a servir a su prójimo.',
    ],
    rotate: '25deg',
    pin: { x: 75, y: 45, angle: 30, len: 80, label: 'Visión 2030' }
  },
  {
    id: 'valores',
    title: 'Principios y Valores',
    content: [
      'Enseñamos la Palabra de Dios como fundamento de fe y práctica.',
      'Procuramos depender de Dios a través de hábitos de vida piadosos.',
      'Desafiamos a servir a Dios en el liderazgo para el uso de los dones.',
      'Proclamamos nuestra fe para dar a conocer a Dios.',
      'Propiciamos ambientes de Adoración y de consagración a Dios.',
    ],
    rotate: '60deg',
  },
  {
    id: 'objetivos',
    title: 'Nuestros Objetivos',
    content: [
      'Cumplir en obediencia la gran comisión de llevar el evangelio hasta lo último de la tierra.',
      'Discipular a quienes han experimentado un nuevo nacimiento hasta que lleguen a la madurez.',
      'Capacitar a los hijos de Dios por el Espíritu Santo en el uso de sus dones.',
    ],
    rotate: '100deg',
    pin: { x: 50, y: 50, angle: -90, len: 65, label: 'Objetivos' }
  },
];
---

<section id="cap-identidad" class="relative bg-[#1A255C] text-white overflow-hidden" style="contain: paint;" data-parallax-bg>
  <!-- Background atmos -->
  <div class="absolute inset-0 z-0" data-bg>
    <div class="absolute top-0 left-0 w-full h-[50vh] bg-gradient-to-b from-[#151e4a] to-transparent"></div>
    <!-- Nebula glow -->
    <div class="absolute top-[20%] right-[-10%] w-[800px] h-[800px] bg-brand-teal/10 rounded-full blur-[120px] mix-blend-screen animate-pulse-slow"></div>
    <div class="absolute bottom-[10%] left-[-10%] w-[600px] h-[600px] bg-brand-medium/10 rounded-full blur-[100px] mix-blend-screen"></div>
  </div>

  <div class="container-tight relative z-10 grid gap-10 lg:grid-cols-2 min-h-screen py-24">
    
    <!-- Left Column: Scroll Content -->
    <div class="flex flex-col gap-[80vh] py-[20vh] relative z-20">
      {sections.map((item, index) => (
        <article 
          class="flex flex-col justify-center min-h-[50vh] transition-opacity duration-500"
          data-history-scene
          data-rotate={item.rotate}
          id={`scene-${item.id}`}
        >
          {item.id === 'intro' ? (
             /* Special layout for Intro */
            <div class="space-y-4" data-animate="fade-up">
              <p class="text-2xl font-light tracking-[0.2em] font-display text-brand-teal/80">Es momento de</p>
              <h2 class="text-6xl md:text-8xl font-black leading-[0.9] text-transparent bg-clip-text bg-gradient-to-r from-brand-teal via-white to-brand-teal">
                ORAR<br/>AGRADECER
              </h2>
            </div>
          ) : (
            <div class="space-y-8" data-animate="fade-up">
               <div class="flex items-center gap-4">
                  <span class="text-xs font-bold font-mono text-brand-teal/60">0{index + 1}</span>
                  <div class="h-px w-12 bg-brand-teal/40"></div>
               </div>
               
               <h2 class="text-4xl md:text-6xl font-black leading-tight text-white mb-6">
                 {item.title} <br/>
                 {item.highlight && <span class="text-brand-teal">{item.highlight}</span>}
               </h2>

               <div class="space-y-6">
                 {item.content.map((paragraph) => (
                   item.id === 'valores' || item.id === 'objetivos' ? (
                     /* List style for values/objectives */
                     <div class="flex gap-4 group">
                       <div class="mt-1.5 w-2 h-2 rounded-full bg-brand-teal group-hover:shadow-[0_0_10px_var(--mana-teal)] transition-all"></div>
                       <p class="text-lg text-white/80 leading-relaxed max-w-lg font-light group-hover:text-white transition-colors">{paragraph}</p>
                     </div>
                   ) : (
                     /* Standard paragraph */
                     <p class="text-xl text-white/80 leading-relaxed max-w-lg font-light text-pretty border-l-2 border-brand-teal/20 pl-6 hover:border-brand-teal/60 transition-colors">
                       {paragraph}
                     </p>
                   )
                 ))}
               </div>
            </div>
          )}
        </article>
      ))}
    </div>

    <!-- Right Column: Sticky Visual (Globe) -->
    <div class="hidden lg:block relative h-full">
      <div class="sticky top-[20vh] h-[60vh] flex items-center justify-center perspective-1000">
        
        <!-- The Atmos Globe -->
        <div class="relative w-[500px] h-[500px] transition-all duration-1000 ease-out preserve-3d" data-history-globe>
          <!-- Outer Ring -->
          <div class="absolute inset-[-20px] rounded-full border border-white/5 opacity-80 animate-[spin_60s_linear_infinite]"></div>
          <div class="absolute inset-[-60px] rounded-full border border-white/5 opacity-40 animate-[spin_80s_linear_infinite_reverse]"></div>
          
          <!-- Globe Sphere -->
          <div class="absolute inset-0 rounded-full bg-[#1c2850] shadow-[inset_0_0_80px_rgba(0,0,0,0.8),0_0_50px_rgba(40,166,189,0.1)] overflow-hidden backdrop-blur-sm border border-white/10">
            <!-- Map Texture -->
            <div class="absolute inset-[-25%] w-[150%] h-[150%] bg-[url('/img/dots-map.png')] bg-cover opacity-40 mix-blend-overlay transition-transform duration-1000 ease-out" 
                 style="transform: rotate(var(--globe-rotate, 0deg)) scale(1.2);"></div>
            
            <!-- Atmosphere Glow -->
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_30%,rgba(40,166,189,0.2),transparent_60%)]"></div>
          </div>
          
          <!-- Dynamic Pins -->
          {sections.map((item) => item.pin && (
             <div 
               class="absolute top-1/2 left-1/2 w-0 h-0 transition-opacity duration-500"
               style={`opacity: 0`} 
               data-pin-for={item.id}
             >
               <div class="absolute w-1 h-1 bg-white rounded-full shadow-[0_0_15px_white]"
                    style={`transform: rotate(${item.pin.angle}deg) translateX(${item.pin.len + 20}px)`}></div>
               <div class="absolute h-px bg-gradient-to-r from-transparent via-white to-transparent"
                    style={`width: ${item.pin.len * 2}px; transform: translate(-50%, -50%) rotate(${item.pin.angle}deg);`}></div>
             </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script nonce={cspNonce}>
  /* Local Script for granular control of this specific component */
  function initHistory() {
    const scenes = document.querySelectorAll('[data-history-scene]');
    const globe = document.querySelector('[data-history-globe]') as HTMLElement;
    
    if (!scenes.length || !globe) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Activate scene
          entry.target.classList.add('opacity-100', 'translate-y-0');
          entry.target.classList.remove('opacity-30', 'translate-y-10');
          
          // Rotate globe
          const rot = (entry.target as HTMLElement).dataset.rotate || '0deg';
          globe.style.setProperty('--globe-rotate', rot);
          
          // Pins logic could go here
        } else {
           entry.target.classList.add('opacity-30', 'translate-y-10');
           entry.target.classList.remove('opacity-100', 'translate-y-0');
        }
      });
    }, {
      threshold: 0.5,
      rootMargin: '-10% 0px -10% 0px'
    });

    scenes.forEach(scene => {
        scene.classList.add('transition-all', 'duration-700', 'opacity-30', 'translate-y-10'); // Init state
        observer.observe(scene);
    });
  }

  // Run on load and swap
  document.addEventListener('astro:page-load', initHistory);
  document.addEventListener('DOMContentLoaded', initHistory);
</script>

<style>
  .preserve-3d { transform-style: preserve-3d; }
  .text-pretty { text-wrap: pretty; }
</style>
