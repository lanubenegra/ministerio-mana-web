---
const cspNonce = Astro.locals?.cspNonce;
---

<div id="registro-app" class="max-w-4xl mx-auto space-y-8">
  
  <!-- Loading State -->
  <div id="loading-state" class="text-center py-20">
     <div class="w-16 h-16 border-4 border-brand-teal border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-white/60">Cargando datos de tu reserva...</p>
  </div>

  <!-- Error State -->
  <div id="error-state" class="hidden text-center py-20 bg-red-500/10 border border-red-500/20 rounded-3xl">
     <p class="text-red-400 font-bold text-lg mb-2">No pudimos cargar la reserva</p>
     <p class="text-white/60 text-sm max-w-md mx-auto">Verifica que el enlace sea correcto o contacta a soporte.</p>
  </div>

  <!-- Auth Required State -->
  <div id="auth-state" class="hidden text-center py-20 bg-brand-teal/10 border border-brand-teal/30 rounded-3xl">
     <p class="text-brand-teal font-bold text-lg mb-2">Activa tu cuenta para continuar</p>
     <p class="text-white/60 text-sm max-w-md mx-auto">Te enviaremos un enlace para crear tu contraseña y volver a este formulario.</p>
     <button id="auth-cta" type="button" class="mt-6 px-6 py-3 rounded-xl bg-brand-teal text-white font-bold hover:bg-brand-teal/90 transition-all">
       Enviar enlace de activación
     </button>
     <p id="auth-status" class="text-xs text-white/60 mt-3"></p>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden space-y-8">
     
     <!-- Booking Summary -->
     <div class="bg-white/5 border border-white/10 rounded-2xl p-6 flex flex-wrap gap-6 justify-between items-center">
        <div>
           <p class="text-xs uppercase tracking-wider text-white/50 font-bold mb-1">Reserva #</p>
           <p class="text-2xl font-mono font-bold text-white" id="booking-ref">...</p>
        </div>
        <div>
           <p class="text-xs uppercase tracking-wider text-white/50 font-bold mb-1">Titular</p>
           <p class="text-lg text-white" id="booking-holder">...</p>
        </div>
        <div class="text-right">
           <p class="text-xs uppercase tracking-wider text-white/50 font-bold mb-1">Estado</p>
           <span class="inline-block px-3 py-1 rounded-full bg-blue-500/20 text-blue-300 text-xs font-bold border border-blue-500/30">Confirmado</span>
        </div>
     </div>

     <form id="details-form" class="space-y-6">
        <div id="participants-container" class="space-y-4">
           <!-- Cards injected here -->
        </div>

        <div class="pt-8 border-t border-white/10 flex justify-end">
           <button type="submit" id="btn-save" class="bg-brand-teal text-white px-8 py-4 rounded-xl font-bold shadow-[0_0_20px_rgba(40,166,189,0.3)] hover:scale-105 transition-transform">
              Guardar y Finalizar
           </button>
        </div>
     </form>

  </div>
</div>

<template id="participant-card-template">
  <div class="participant-card bg-white/5 border border-white/10 rounded-2xl overflow-hidden transition-all hover:border-brand-teal/50">
     <!-- Header -->
     <div class="p-4 bg-white/5 flex justify-between items-center cursor-pointer toggle-btn">
        <div class="flex items-center gap-4">
           <div class="w-10 h-10 rounded-full bg-brand-teal/20 text-brand-teal flex items-center justify-center font-bold index-badge">1</div>
           <div>
              <p class="font-bold text-white text-lg name-display">Nombre</p>
              <p class="text-xs text-white/50 type-display">Tipo</p>
           </div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white/40 arrow-icon transform transition-transform" viewBox="0 0 20 20" fill="currentColor">
           <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
     </div>
     
     <!-- Body -->
     <div class="card-body p-6 space-y-6 border-t border-white/5"> <!-- Hidden by default handled by JS height? or just class hidden -->
        <!-- Personal ID -->
        <div class="grid md:grid-cols-2 gap-4">
           <div>
              <label class="block text-xs text-white/60 mb-2 uppercase font-bold">Tipo Documento</label>
              <select name="docType" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white outline-none focus:border-brand-teal">
                 <option value="CC">Cédula de Ciudadanía</option>
                 <option value="TI">Tarjeta de Identidad</option>
                 <option value="RC">Registro civil</option>
                 <option value="PASSPORT">Pasaporte</option>
                 <option value="CE">Cédula de Extranjería</option>
                 <option value="NATIONAL_ID">ID nacional</option>
                 <option value="OTHER">Otro documento</option>
              </select>
           </div>
           <div>
              <label class="block text-xs text-white/60 mb-2 uppercase font-bold">Número Documento</label>
              <input type="text" name="docNumber" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white outline-none focus:border-brand-teal" placeholder="123456789">
           </div>
        </div>

        <div class="doc-other hidden">
           <label class="block text-xs text-white/60 mb-2 uppercase font-bold">Otro documento (especifica)</label>
           <input type="text" name="docOtherType" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white outline-none focus:border-brand-teal" placeholder="Ej: ID nacional, licencia">
        </div>

        <div class="grid md:grid-cols-2 gap-4">
           <div>
              <label class="block text-xs text-white/60 mb-2 uppercase font-bold">Fecha Nacimiento</label>
              <input
                type="text"
                name="birthDate"
                class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white outline-none focus:border-brand-teal js-date"
                placeholder="DD / MM / AAAA"
                inputmode="numeric"
                autocomplete="bday"
              >
           </div>
           <div>
              <label class="block text-xs text-white/60 mb-2 uppercase font-bold">Género</label>
              <select name="gender" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white outline-none focus:border-brand-teal">
                 <option value="">Seleccionar</option>
                 <option value="M">Masculino</option>
                 <option value="F">Femenino</option>
              </select>
           </div>
        </div>

        <!-- Menu Type -->
        <div>
           <label class="block text-xs text-white/60 mb-2 uppercase font-bold">Tipo de menú</label>
           <select name="menuType" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-3 text-white outline-none focus:border-brand-teal">
              <option value="">Seleccionar</option>
              <option value="TRADICIONAL">Menú tradicional</option>
              <option value="VEGETARIANO">Menú vegetariano</option>
              <option value="INFANTIL">Menú infantil</option>
              <option value="SIN ALIMENTACION">Sin alimentación (0-4)</option>
           </select>
           <p class="text-xs text-white/30 mt-1">Menú tradicional, vegetariano o infantil según el paquete.</p>
        </div>
     </div>
  </div>
</template>

<!-- Validation Modal -->
<div id="registro-validation-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
  <div id="registro-validation-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="relative z-10 w-[92%] max-w-lg rounded-2xl border border-white/10 bg-brand-navy/95 p-6 shadow-2xl">
     <button id="registro-validation-close" type="button" class="absolute right-4 top-4 text-white/60 hover:text-white text-xl leading-none">×</button>
     <h3 class="text-xl font-bold text-white mb-2">Faltan datos por completar</h3>
     <p class="text-sm text-white/60 mb-4">Revisa los campos marcados en rojo:</p>
     <ul id="registro-validation-list" class="space-y-2 text-sm text-white/80 list-disc pl-5"></ul>
  </div>
</div>

<style>
  .flatpickr-calendar {
    background: #0b1222;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 20px 40px rgba(2, 6, 23, 0.55);
    border-radius: 16px;
    padding: 8px;
    color: #e2e8f0;
  }
  .flatpickr-months {
    background: #0b1222;
    border-radius: 12px;
    padding: 8px 6px 0;
  }
  .flatpickr-current-month {
    font-weight: 700;
    color: #e2e8f0;
  }
  .flatpickr-weekday {
    color: rgba(148, 163, 184, 0.9);
    font-weight: 600;
  }
  .flatpickr-day {
    color: #e2e8f0;
    border-radius: 10px;
  }
  .flatpickr-day:hover {
    background: rgba(56, 189, 248, 0.2);
    border-color: transparent;
  }
  .flatpickr-day.selected,
  .flatpickr-day.startRange,
  .flatpickr-day.endRange {
    background: #22d3ee;
    color: #0f172a;
    border-color: transparent;
  }
  .flatpickr-day.today {
    border-color: rgba(34, 211, 238, 0.5);
  }
  .flatpickr-prev-month,
  .flatpickr-next-month {
    color: #94a3b8;
  }
  .flatpickr-time input,
  .flatpickr-time .flatpickr-time-separator {
    color: #e2e8f0;
  }
</style>

<script type="module" src={Astro.resolve('../../scripts/registro-flow.js')} nonce={cspNonce}></script>
