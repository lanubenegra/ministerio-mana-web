---
const { countryGroup = 'CO' } = Astro.props;
const isColombia = countryGroup === 'CO';
const countryLabel = isColombia ? 'Colombia' : 'Internacional';
const currencyLabel = isColombia ? 'Pago en Pesos (COP)' : 'Pago en D칩lares (USD)';
const countryEmoji = isColombia ? '游뻟릖' : '游깵';
const currencyCode = isColombia ? 'COP' : 'USD';

const pricing = isColombia
  ? {
      lodging: 850000,
      no_lodging: 660000,
      child_0_7: 300000,
      child_7_13: 550000,
    }
  : {
      lodging: 220,
      no_lodging: 170,
      child_0_7: 80,
      child_7_13: 140,
    };

const priceRows = [
  { label: 'Asistente + alojamiento', key: 'lodging' },
  { label: 'Asistente sin alojamiento', key: 'no_lodging' },
  { label: 'Ni침os 0 a 7 a침os', key: 'child_0_7' },
  { label: 'Ni침os 7 a 13 a침os', key: 'child_7_13' },
];

const formatter = new Intl.NumberFormat(isColombia ? 'es-CO' : 'en-US', {
  style: 'currency',
  currency: currencyCode,
  maximumFractionDigits: 0,
});
const formatPrice = (value) => formatter.format(value);
---

<div id="cumbre-form-app" data-country-group={countryGroup} class="grid lg:grid-cols-[2fr_1fr] gap-8 items-start">
  
  <!-- Left Column: Steps -->
  <div class="space-y-8">
    
    <!-- Step Indicator -->
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 pb-10 backdrop-blur-md">
       <div class="flex items-center justify-between relative">
          <!-- Connector Line -->
          <div class="absolute left-0 right-0 top-1/2 h-0.5 bg-white/10 -z-10"></div>
          
          <button type="button" class="step-btn active relative" data-step="1">
             <span class="w-10 h-10 rounded-full bg-brand-teal text-white flex items-center justify-center font-bold">1</span>
             <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-xs font-bold text-white whitespace-nowrap">Ubicaci칩n</span>
          </button>
          
          <button type="button" class="step-btn opacity-50 relative" data-step="2">
             <span class="w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center font-bold border border-white/20">2</span>
             <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-xs font-bold text-white/60 whitespace-nowrap">Grupo</span>
          </button>

          <button type="button" class="step-btn opacity-50 relative" data-step="3">
             <span class="w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center font-bold border border-white/20">3</span>
             <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-xs font-bold text-white/60 whitespace-nowrap">Confirmar</span>
          </button>
       </div>
    </div>

    <!-- SCREENS -->
    <form id="booking-form" class="bg-white/5 border border-white/10 rounded-3xl p-8 backdrop-blur-sm min-h-[400px]">
      
      <!-- STEP 1: Country & Leader -->
      <div id="step-1" class="step-content space-y-6">
         <h2 class="text-2xl font-bold text-white">Tu ubicaci칩n</h2>
         
         <div class="space-y-3">
            <div class="flex items-center gap-4 p-6 rounded-2xl border border-white/10 bg-white/5">
               <span class="text-3xl">{countryEmoji}</span>
               <div>
                  <span class="font-bold text-white block">{countryLabel}</span>
                  <span class="text-xs text-white/60">{currencyLabel}</span>
               </div>
            </div>
            <p class="text-xs text-white/50">
               Detectamos tu ubicaci칩n autom치ticamente para mostrar el precio correcto.
            </p>
            <input type="hidden" name="countryGroup" id="country-group" value={countryGroup}>
         </div>

         <div class="bg-white/5 border border-white/10 rounded-2xl p-6 space-y-4">
            <div class="flex items-center justify-between">
               <h3 class="text-lg font-semibold text-white">Tarifas {countryLabel}</h3>
               <span class="text-xs text-white/40 uppercase tracking-wider">{currencyCode}</span>
            </div>
            <div class="grid md:grid-cols-2 gap-3 text-sm">
               {priceRows.map((row) => (
                 <div class="flex items-center justify-between bg-black/20 rounded-lg px-4 py-3 border border-white/5">
                   <span class="text-white/80">{row.label}</span>
                   <span class="font-bold text-white">{formatPrice(pricing[row.key])}</span>
                 </div>
               ))}
            </div>
            <div class="text-xs text-white/50 space-y-2">
               <p>Los valores se muestran seg칰n tu ubicaci칩n.</p>
               <p>
                 Ni침os 0 a 7 a침os: el valor incluye solo material de trabajo. Si requiere alimentaci칩n y alojamiento
                 individual, cont치ctanos. <a href="/eventos/cumbre-mundial-2026/condiciones" class="underline hover:text-white">Ver condiciones comerciales</a>.
               </p>
            </div>
         </div>

         <div class="space-y-4 pt-4">
            <h3 class="text-lg font-medium text-white">Datos del Responsable</h3>
            <p class="text-xs text-white/50">
               El responsable se agrega autom치ticamente como participante. Puedes eliminarlo si no asistir치.
            </p>
            <div class="grid md:grid-cols-2 gap-4">
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Nombre Completo</label>
                  <input type="text" name="leaderName" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:border-brand-teal focus:ring-1 focus:ring-brand-teal outline-none transition-all" placeholder="Ej: Juan P칠rez">
               </div>
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Email</label>
                  <input type="email" name="leaderEmail" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:border-brand-teal focus:ring-1 focus:ring-brand-teal outline-none transition-all" placeholder="juan@email.com">
               </div>
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Tel칠fono / WhatsApp</label>
                  <input type="tel" name="leaderPhone" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:border-brand-teal focus:ring-1 focus:ring-brand-teal outline-none transition-all" placeholder="+57 300 123 4567">
               </div>
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Tipo de asistencia</label>
                  <select name="leaderPackage" id="leader-package" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-brand-teal focus:ring-1 focus:ring-brand-teal transition-all">
                     <option value="lodging">Con alojamiento</option>
                     <option value="no_lodging">Sin alojamiento</option>
                  </select>
               </div>
            </div>
         </div>

         <div class="pt-4 flex justify-end">
            <button type="button" class="btn-next bg-brand-teal text-white px-8 py-3 rounded-xl font-bold hover:brightness-110 transition-all">
               Siguiente &rarr;
            </button>
         </div>
      </div>

      <!-- STEP 2: Group Builder -->
      <div id="step-2" class="step-content hidden space-y-6">
         <h2 class="text-2xl font-bold text-white">Configura tu Grupo</h2>
         <p class="text-white/60 text-sm">Agrega a todas las personas que asistir치n contigo. Incluye la edad para calcular el valor.</p>

         <div class="bg-white/5 border border-white/10 rounded-xl p-4 space-y-3">
            <p class="text-white/70 text-sm font-medium">쯌as solo o con acompa침antes?</p>
            <div class="grid sm:grid-cols-2 gap-3 text-sm">
               <label class="cursor-pointer group">
                  <input type="radio" name="groupMode" value="SOLO" class="peer sr-only">
                  <div class="text-center p-3 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Voy solo</span>
                     <span class="block text-xs text-white/60">Solo el responsable</span>
                  </div>
               </label>
               <label class="cursor-pointer group">
                  <input type="radio" name="groupMode" value="GROUP" class="peer sr-only" checked>
                  <div class="text-center p-3 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Con acompa침antes</span>
                     <span class="block text-xs text-white/60">Agregar m치s personas</span>
                  </div>
               </label>
            </div>
         </div>
         
         <!-- Add Person Form -->
         <div id="add-person-box" class="bg-white/5 border border-white/10 rounded-xl p-4 space-y-4">
            <div class="grid lg:grid-cols-[2fr_1fr_1fr] gap-3">
               <input type="text" id="new-p-name" placeholder="Nombre del asistente" class="bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white outline-none focus:border-brand-teal">
               <input type="number" id="new-p-age" min="0" max="120" placeholder="Edad" class="bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white outline-none focus:border-brand-teal">
               <div class="space-y-2">
                  <select id="new-p-lodging" class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white outline-none focus:border-brand-teal">
                     <option value="lodging">Con alojamiento</option>
                     <option value="no_lodging">Sin alojamiento</option>
                  </select>
                  <p class="text-[11px] text-white/40">Aplica para mayores de 13 a침os.</p>
               </div>
            </div>
            <button type="button" id="btn-add-person" class="w-full py-2 border border-brand-teal text-brand-teal rounded-lg font-bold hover:bg-brand-teal hover:text-white transition-all text-sm uppercase tracking-wide">
               + Agregar Persona
            </button>
         </div>

         <!-- List -->
         <div id="participants-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
            <!-- Items injected by JS -->
            <div class="text-center text-white/30 py-4 italic text-sm" id="empty-msg">No hay participantes a칰n</div>
         </div>

         <div class="pt-4 flex justify-between items-center">
            <button type="button" class="btn-prev text-white/60 hover:text-white underline">
               &larr; Volver
            </button>
            <button type="button" class="btn-next bg-brand-teal text-white px-8 py-3 rounded-xl font-bold hover:brightness-110 transition-all">
               Siguiente &rarr;
            </button>
         </div>
      </div>

      <!-- STEP 3: Payment & Confirm -->
      <div id="step-3" class="step-content hidden space-y-6">
         <h2 class="text-2xl font-bold text-white">Resumen y Pago</h2>
         
         <div class="bg-white/5 rounded-xl p-6 border border-white/10 space-y-4">
            <div class="flex justify-between text-white/70 text-sm">
               <span>Total Grupo:</span>
               <span id="summary-total" class="text-white font-bold text-lg">$0</span>
            </div>
            
            <div class="h-px bg-white/10"></div>
            
            <h3 class="font-bold text-white text-sm uppercase tracking-wide">Opciones de Pago</h3>
            <p class="text-white/60 text-sm">Elige c칩mo deseas pagar. Puedes completar el valor, reservar tu cupo o pagar a cuotas.</p>
            <div class="grid md:grid-cols-3 gap-4">
               <label class="cursor-pointer group">
                  <input type="radio" name="paymentOption" value="FULL" class="peer sr-only" checked>
                  <div class="text-center p-4 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Pago Total</span>
                     <span class="block text-xs text-brand-teal mt-1">100%</span>
                  </div>
               </label>
               <label class="cursor-pointer group">
                  <input type="radio" name="paymentOption" value="DEPOSIT" class="peer sr-only">
                  <div class="text-center p-4 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Reserva de cupo</span>
                     <span class="block text-xs text-brand-teal mt-1" id="deposit-amount">50%</span>
                  </div>
               </label>
               <label class="cursor-pointer group">
                  <input type="radio" name="paymentOption" value="INSTALLMENTS" class="peer sr-only">
                  <div class="text-center p-4 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Pago a cuotas</span>
                     <span class="block text-xs text-brand-teal mt-1">Elige tu abono</span>
                  </div>
               </label>
            </div>
            <div id="custom-amount-box" class="hidden bg-black/20 border border-white/10 rounded-xl p-4 space-y-2">
               <label class="block text-xs font-bold text-white/60 uppercase tracking-wider">Valor del abono</label>
               <input type="number" id="custom-amount" min="1" step="1" class="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white outline-none focus:border-brand-teal" placeholder="Ingresa el valor que deseas pagar">
               <p class="text-xs text-white/40">Puedes hacer varios pagos hasta completar el total.</p>
            </div>
            <p class="text-xs text-white/50">
               El cupo con alojamiento se garantiza con un abono igual o superior al 50%.
               <a href="/eventos/cumbre-mundial-2026/condiciones" class="underline hover:text-white">Ver condiciones comerciales</a>.
            </p>

            <div class="bg-brand-medium/20 rounded-lg p-3 text-xs text-white/80 flex gap-2 items-start">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-teal flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
               </svg>
               <p>Al hacer clic en "Ir a Pagar", ser치s redirigido a Wompi (Colombia) o Stripe (internacional). No guardamos datos de tarjeta en este sitio.</p>
            </div>
         </div>

         <div class="pt-4 flex justify-between items-center">
            <button type="button" class="btn-prev text-white/60 hover:text-white underline">
               &larr; Volver
            </button>
            <button type="submit" id="btn-pay" class="bg-gradient-to-r from-brand-teal to-[#4CC9E0] text-white px-8 py-4 rounded-xl font-bold shadow-lg w-full md:w-auto hover:scale-105 transition-transform">
               Ir a Pagar <span id="pay-amount-label"></span>
            </button>
         </div>
         <div id="error-msg" class="hidden text-pink-500 text-sm text-center"></div>
      </div>

    </form>
  </div>

  <!-- Right Column: Summary Sticky -->
  <div class="hidden lg:block">
     <div class="sticky top-24 bg-white/5 border border-white/10 rounded-3xl p-6 backdrop-blur-md">
        <h3 class="text-white font-bold mb-4 uppercase tracking-wider text-sm">Tu Inscripci칩n</h3>
        <div id="sidebar-list" class="space-y-2 text-sm text-white/70 mb-4">
           <!-- Dynamic mirror -->
           <p class="italic text-white/30">Agrega participantes para ver el resumen</p>
        </div>
        <div class="border-t border-white/10 pt-4 mt-auto">
           <div class="flex justify-between items-center mb-1">
              <span class="text-white/60">Subtotal</span>
              <span class="text-white font-mono" id="side-subtotal">$0</span>
           </div>
           <div class="flex justify-between items-center text-xl font-bold text-brand-teal">
              <span>Total Estimado</span>
              <span id="side-total">$0</span>
           </div>
        </div>
     </div>
  </div>

</div>

<script>
  // Simple Vanilla JS Logic
  const APP = {
    step: 1,
    participants: [],
    currency: 'COP', // or USD
    countryGroup: 'CO',
    leaderId: 'leader',
    leaderOptOut: false,
    isSolo: false,
    prices: {
       CO: {
          lodging: 850000,
          no_lodging: 660000,
          child_0_7: 300000,
          child_7_13: 550000
       },
       INT: {
          lodging: 220,
          no_lodging: 170,
          child_0_7: 80,
          child_7_13: 140
       }
    },
    
    init() {
       this.cacheDOM();
       this.countryGroup = this.dom.app?.dataset.countryGroup || this.dom.countryInput?.value || 'CO';
       this.bindEvents();
       this.updateCurrency();
       this.updateGroupMode();
       this.updateAddPersonControls();
       this.updatePaymentUI();
    },

    cacheDOM() {
       this.dom = {
          app: document.getElementById('cumbre-form-app'),
          steps: document.querySelectorAll('.step-content'),
          btnsNext: document.querySelectorAll('.btn-next'),
          btnsPrev: document.querySelectorAll('.btn-prev'),
          indicators: document.querySelectorAll('.step-btn'),
          countryInput: document.getElementById('country-group'),
          leaderName: document.querySelector('input[name="leaderName"]'),
          leaderPackage: document.getElementById('leader-package'),
          groupModeInputs: document.querySelectorAll('input[name="groupMode"]'),
          btnAddPerson: document.getElementById('btn-add-person'),
          addPersonBox: document.getElementById('add-person-box'),
          inputName: document.getElementById('new-p-name'),
          inputAge: document.getElementById('new-p-age'),
          inputLodging: document.getElementById('new-p-lodging'),
          list: document.getElementById('participants-list'),
          sidebarList: document.getElementById('sidebar-list'),
          emptyMsg: document.getElementById('empty-msg'),
          totalDisplay: document.getElementById('summary-total'),
          payBtnLabel: document.getElementById('pay-amount-label'),
          payBtn: document.getElementById('btn-pay'),
          paymentOptions: document.querySelectorAll('input[name="paymentOption"]'),
          customAmountBox: document.getElementById('custom-amount-box'),
          customAmountInput: document.getElementById('custom-amount'),
          depositAmount: document.getElementById('deposit-amount'),
          form: document.getElementById('booking-form'),
          errorMsg: document.getElementById('error-msg'),
          sideSubtotal: document.getElementById('side-subtotal'),
          sideTotal: document.getElementById('side-total')
       };
    },

    bindEvents() {
       this.dom.btnsNext.forEach(btn => btn.addEventListener('click', () => this.nextStep()));
       this.dom.btnsPrev.forEach(btn => btn.addEventListener('click', () => this.prevStep()));

       this.dom.btnAddPerson.addEventListener('click', () => this.addPerson());
       if (this.dom.inputAge) {
          this.dom.inputAge.addEventListener('input', () => this.updateAddPersonControls());
       }
       
       this.dom.form.addEventListener('submit', (e) => this.handleSubmit(e));

       if (this.dom.leaderName) {
          this.dom.leaderName.addEventListener('input', () => this.updateLeaderName());
       }

       if (this.dom.leaderPackage) {
          this.dom.leaderPackage.addEventListener('change', () => this.updateLeaderPackage());
       }

       if (this.dom.groupModeInputs?.length) {
          this.dom.groupModeInputs.forEach(input => {
             input.addEventListener('change', () => this.updateGroupMode());
          });
       }

       if (this.dom.paymentOptions?.length) {
          this.dom.paymentOptions.forEach(input => {
             input.addEventListener('change', () => this.updatePaymentUI());
          });
       }

       if (this.dom.customAmountInput) {
          this.dom.customAmountInput.addEventListener('input', () => this.updatePayLabel());
       }
    },

    nextStep() {
       if(this.step === 1) {
          if(!this.validateStep1()) return;
          this.ensureLeaderParticipant();
          this.renderList();
          this.updateTotals();
       }
       if(this.step === 2 && this.participants.length === 0) {
          alert('Debes agregar al menos un participante');
          return;
       }
       this.step++;
       this.render();
    },

    prevStep() {
       if(this.step > 1) {
          this.step--;
          this.render();
       }
    },

    validateStep1() {
       const fd = new FormData(this.dom.form);
       if(!fd.get('leaderName') || !fd.get('leaderEmail') || !fd.get('leaderPhone') || !fd.get('leaderPackage')) {
          alert('Por favor completa los datos del responsable');
          return false;
       }
       return true;
    },

    getLeaderName() {
       return this.dom.leaderName?.value?.trim() || '';
    },

    getLeaderPackageType() {
       const value = this.dom.leaderPackage?.value;
       return value === 'no_lodging' ? 'no_lodging' : 'lodging';
    },

    ensureLeaderParticipant() {
       if (this.leaderOptOut) return;
       const name = this.getLeaderName();
       if (!name) return;

       const existing = this.participants.find(p => p.isLeader);
       if (existing) {
          existing.name = name;
          existing.packageType = this.getLeaderPackageType();
          return;
       }

       const packageType = this.getLeaderPackageType();
       this.participants.unshift({ name, packageType, id: this.leaderId, isLeader: true });
    },

    updateLeaderName() {
       const name = this.getLeaderName();
       if (!name) return;
       const leader = this.participants.find(p => p.isLeader);
       if (!leader) return;
       leader.name = name;
       this.renderList();
    },

    updateLeaderPackage() {
       const leader = this.participants.find(p => p.isLeader);
       if (!leader) return;
       leader.packageType = this.getLeaderPackageType();
       this.renderList();
       this.updateTotals();
    },

    parseAge(value) {
       const parsed = Number.parseInt(value, 10);
       return Number.isFinite(parsed) ? parsed : null;
    },

    getPackageTypeFromAge(age, lodgingChoice) {
       if (age <= 7) return 'child_0_7';
       if (age <= 13) return 'child_7_13';
       return lodgingChoice === 'no_lodging' ? 'no_lodging' : 'lodging';
    },

    updateAddPersonControls() {
       const age = this.parseAge(this.dom.inputAge?.value || '');
       const isChild = typeof age === 'number' && age <= 13;
       if (this.dom.inputLodging) {
          this.dom.inputLodging.disabled = isChild;
          const container = this.dom.inputLodging.parentElement;
          if (container) {
             container.classList.toggle('opacity-60', isChild);
          }
       }
    },

    updateGroupMode() {
       const selected = document.querySelector('input[name="groupMode"]:checked');
       this.isSolo = selected?.value === 'SOLO';

       if (this.dom.addPersonBox) {
          this.dom.addPersonBox.classList.toggle('hidden', this.isSolo);
       }

       if (this.isSolo) {
          const hasCompanions = this.participants.some(p => !p.isLeader);
          if (hasCompanions) {
             const ok = confirm('Al seleccionar "Voy solo" se eliminar치n los acompa침antes agregados. 쮻eseas continuar?');
             if (!ok) {
                const groupOption = document.querySelector('input[name="groupMode"][value="GROUP"]');
                if (groupOption) {
                   groupOption.checked = true;
                   this.isSolo = false;
                   if (this.dom.addPersonBox) {
                      this.dom.addPersonBox.classList.remove('hidden');
                   }
                }
                return;
             }
             this.participants = this.participants.filter(p => p.isLeader);
             this.renderList();
             this.updateTotals();
          }
       }
    },

    addPerson() {
       const name = this.dom.inputName.value.trim();
       const age = this.parseAge(this.dom.inputAge?.value || '');
       const lodgingChoice = this.dom.inputLodging?.value || 'lodging';
       
       if(!name) {
          alert('Ingresa el nombre del participante');
          return;
       }

       if(age == null || age < 0 || age > 120) {
          alert('Ingresa una edad v치lida');
          return;
       }

       const packageType = this.getPackageTypeFromAge(age, lodgingChoice);
       this.participants.push({ name, age, packageType, id: Date.now() });
       this.dom.inputName.value = '';
       if (this.dom.inputAge) this.dom.inputAge.value = '';
       this.renderList();
       this.updateTotals();
    },

    removePerson(id) {
       const removed = this.participants.find(p => p.id === id);
       if (removed?.isLeader) {
          this.leaderOptOut = true;
       }
       this.participants = this.participants.filter(p => p.id !== id);
       this.renderList();
       this.updateTotals();
    },

    renderList() {
       this.dom.list.innerHTML = '';
       this.dom.sidebarList.innerHTML = '';

       if(this.participants.length === 0) {
          this.dom.list.appendChild(this.dom.emptyMsg);
          this.dom.sidebarList.innerHTML = '<p class="italic text-white/30">Agrega participantes...</p>';
          return;
       }

       this.participants.forEach(p => {
          // Main List Item
          const el = document.createElement('div');
          el.className = 'flex justify-between items-center bg-black/20 p-3 rounded-lg border border-white/5';
          const leaderBadge = p.isLeader
             ? '<span class="ml-2 text-[10px] uppercase tracking-wider text-brand-teal/80">Responsable</span>'
             : '';
          const ageLabel = typeof p.age === 'number' ? ` 췅 ${p.age} a침os` : '';
          const removeId = JSON.stringify(p.id);
          el.innerHTML = `
             <div>
                <div class="font-bold text-white text-sm">${p.name}${leaderBadge}</div>
                <div class="text-xs text-white/60">${this.getTypeLabel(p.packageType)}${ageLabel}</div>
             </div>
             <button type="button" class="text-pink-400 hover:text-pink-300 text-xs underline p-2" onclick="document.dispatchEvent(new CustomEvent('remove-p', {detail: ${removeId}}))">Eliminar</button>
          `;
          this.dom.list.appendChild(el);

          // Sidebar Item
          const sideEl = document.createElement('div');
          sideEl.className = 'flex justify-between text-xs text-white/80';
          sideEl.innerHTML = `<span>${p.name}</span> <span class="opacity-50">${this.formatPrice(this.getPrice(p.packageType))}</span>`;
          this.dom.sidebarList.appendChild(sideEl);
       });
    },

    getPrice(type) {
       const map = this.currency === 'COP' ? this.prices.CO : this.prices.INT;
       return map[type] || 0;
    },
    
    getTypeLabel(type) {
        const labels = {
            lodging: 'Adulto con alojamiento',
            no_lodging: 'Adulto sin alojamiento',
            child_0_7: 'Ni침o 0-7',
            child_7_13: 'Ni침o 7-13'
        };
        return labels[type] || type;
    },

    formatPrice(amount) {
       if(this.currency === 'COP') {
          return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(amount);
       }
       return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(amount);
    },

    getDepositAmount(total) {
       return Math.round(total * 0.5 * 100) / 100;
    },

    getSelectedPaymentOption() {
       const selected = document.querySelector('input[name="paymentOption"]:checked');
       return selected?.value || 'FULL';
    },

    getCustomAmount() {
       const raw = this.dom.customAmountInput?.value || '';
       const value = Number(raw);
       if (!Number.isFinite(value) || value <= 0) return null;
       return value;
    },

    getPaymentAmount(total) {
       const option = this.getSelectedPaymentOption();
       if (option === 'FULL') return total;
       if (option === 'DEPOSIT') return this.getDepositAmount(total);
       if (option === 'INSTALLMENTS') return this.getCustomAmount();
       return total;
    },

    updatePayLabel(total) {
       const baseTotal = typeof total === 'number'
          ? total
          : this.participants.reduce((sum, p) => sum + this.getPrice(p.packageType), 0);
       const amount = this.getPaymentAmount(baseTotal);
       if (amount) {
          this.dom.payBtnLabel.textContent = `(${this.formatPrice(amount)})`;
       } else {
          this.dom.payBtnLabel.textContent = '';
       }
    },

    updatePaymentUI() {
       const option = this.getSelectedPaymentOption();
       if (this.dom.customAmountBox) {
          this.dom.customAmountBox.classList.toggle('hidden', option !== 'INSTALLMENTS');
       }
       const total = this.participants.reduce((sum, p) => sum + this.getPrice(p.packageType), 0);
       this.updatePayLabel(total);
    },

    updateTotals() {
       const total = this.participants.reduce((sum, p) => sum + this.getPrice(p.packageType), 0);
       const fmt = this.formatPrice(total);
       this.dom.totalDisplay.textContent = fmt;
       this.dom.sideSubtotal.textContent = fmt;
       this.dom.sideTotal.textContent = fmt;
       if (this.dom.depositAmount) {
          const deposit = this.getDepositAmount(total);
          this.dom.depositAmount.textContent = this.formatPrice(deposit);
       }
       this.updatePayLabel(total);
    },
    
    updateCurrency() {
        const group = this.dom.countryInput?.value || this.countryGroup || 'CO';
        this.countryGroup = group;
        this.currency = group === 'CO' ? 'COP' : 'USD';
        this.updateTotals();
        this.renderList();
    },

    render() {
       this.dom.steps.forEach(el => el.classList.add('hidden'));
       document.getElementById(`step-${this.step}`).classList.remove('hidden');
       
       this.dom.indicators.forEach((el, idx) => {
          if(idx + 1 === this.step) {
             el.classList.add('active');
             el.querySelector('span').classList.replace('bg-white/10', 'bg-brand-teal');
             el.classList.remove('opacity-50');
          } else if (idx + 1 < this.step) {
             el.classList.add('completed');
             el.classList.remove('opacity-50');
          } else {
             el.classList.remove('active');
             el.querySelector('span').classList.replace('bg-brand-teal', 'bg-white/10');
             el.classList.add('opacity-50');
          }
       });
    },

    async handleSubmit(e) {
       e.preventDefault();
       const fd = new FormData(this.dom.form);
       const participantsPayload = this.participants.map((participant) => ({
          fullName: participant.name,
          packageType: participant.packageType,
       }));
       const data = {
          contactName: fd.get('leaderName'),
          email: fd.get('leaderEmail'),
          phone: fd.get('leaderPhone'),
          countryGroup: fd.get('countryGroup') || this.countryGroup,
          participants: participantsPayload,
       };

       this.dom.errorMsg.classList.add('hidden');
       const btn = this.dom.payBtn;
       const originalText = btn.innerHTML;
       btn.disabled = true;
       btn.innerHTML = 'Procesando...';

       try {
          const res = await fetch('/api/cumbre2026/booking/create', {
             method: 'POST',
             headers: {
                'content-type': 'application/json',
                accept: 'application/json',
             },
             body: JSON.stringify(data),
          });

          const bookingData = await res.json();
          if (!res.ok || !bookingData.ok) {
             throw new Error(bookingData?.error || 'No se pudo crear la reserva');
          }

          const totalAmount = Number(bookingData.totalAmount || 0);
          const depositAmount = Number(bookingData.depositThreshold || this.getDepositAmount(totalAmount));
          const paymentOption = this.getSelectedPaymentOption();
          let paymentKind = 'custom';
          let amount;

          if (paymentOption === 'FULL') {
             paymentKind = 'full';
          } else if (paymentOption === 'DEPOSIT') {
             amount = depositAmount;
          } else {
             amount = this.getCustomAmount();
          }

          if (paymentKind !== 'full' && (!amount || amount <= 0)) {
             throw new Error('Ingresa un valor v치lido para el abono');
          }

          const paymentPayload = {
             bookingId: bookingData.bookingId,
             paymentKind,
             ...(paymentKind !== 'full' ? { amount } : {}),
          };

          const payRes = await fetch('/api/payments/create', {
             method: 'POST',
             headers: {
                'content-type': 'application/json',
                accept: 'application/json',
             },
             body: JSON.stringify(paymentPayload),
          });

          const payData = await payRes.json();
          if (!payRes.ok || !payData?.url) {
             throw new Error(payData?.error || 'No se pudo iniciar el pago');
          }

          window.location.href = payData.url;
       } catch (err) {
          console.error(err);
          this.dom.errorMsg.textContent = err?.message || 'Hubo un error al procesar tu solicitud. Intenta nuevamente.';
          this.dom.errorMsg.classList.remove('hidden');
          btn.disabled = false;
          btn.innerHTML = originalText;
       }
    }
  };

  // Event delegation for removal
  document.addEventListener('remove-p', (e) => {
     APP.removePerson(e.detail);
  });

  // Init
  window.addEventListener('DOMContentLoaded', () => APP.init());

</script>
