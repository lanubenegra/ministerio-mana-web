---
const { countryGroup = 'CO' } = Astro.props;
const isColombia = countryGroup === 'CO';
const countryLabel = isColombia ? 'Colombia' : 'Internacional';
const currencyLabel = isColombia ? 'Pago en Pesos (COP)' : 'Pago en D칩lares (USD)';
const countryEmoji = isColombia ? '游뻟릖' : '游깵';
---

<div id="cumbre-form-app" data-country-group={countryGroup} class="grid lg:grid-cols-[2fr_1fr] gap-8 items-start">
  
  <!-- Left Column: Steps -->
  <div class="space-y-8">
    
    <!-- Step Indicator -->
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-md">
       <div class="flex items-center justify-between relative">
          <!-- Connector Line -->
          <div class="absolute left-0 right-0 top-1/2 h-0.5 bg-white/10 -z-10"></div>
          
          <button type="button" class="step-btn active" data-step="1">
             <span class="w-10 h-10 rounded-full bg-brand-teal text-white flex items-center justify-center font-bold">1</span>
             <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-xs font-bold text-white whitespace-nowrap">Pa칤s</span>
          </button>
          
          <button type="button" class="step-btn opacity-50" data-step="2">
             <span class="w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center font-bold border border-white/20">2</span>
             <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-xs font-bold text-white/60 whitespace-nowrap">Grupo</span>
          </button>

          <button type="button" class="step-btn opacity-50" data-step="3">
             <span class="w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center font-bold border border-white/20">3</span>
             <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 text-xs font-bold text-white/60 whitespace-nowrap">Confirmar</span>
          </button>
       </div>
    </div>

    <!-- SCREENS -->
    <form id="booking-form" class="bg-white/5 border border-white/10 rounded-3xl p-8 backdrop-blur-sm min-h-[400px]">
      
      <!-- STEP 1: Country & Leader -->
      <div id="step-1" class="step-content space-y-6">
         <h2 class="text-2xl font-bold text-white">Tu ubicaci칩n</h2>
         
         <div class="space-y-3">
            <div class="flex items-center gap-4 p-6 rounded-2xl border border-white/10 bg-white/5">
               <span class="text-3xl">{countryEmoji}</span>
               <div>
                  <span class="font-bold text-white block">{countryLabel}</span>
                  <span class="text-xs text-white/60">{currencyLabel}</span>
               </div>
            </div>
            <p class="text-xs text-white/50">
               Detectamos tu ubicaci칩n autom치ticamente para mostrar el precio correcto.
            </p>
            <input type="hidden" name="country" id="country-group" value={countryGroup}>
         </div>

         <div class="space-y-4 pt-4">
            <h3 class="text-lg font-medium text-white">Datos del Responsable</h3>
            <p class="text-xs text-white/50">
               El responsable se agrega autom치ticamente como participante. Puedes eliminarlo si no asistir치.
            </p>
            <div class="grid md:grid-cols-2 gap-4">
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Nombre Completo</label>
                  <input type="text" name="leaderName" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:border-brand-teal focus:ring-1 focus:ring-brand-teal outline-none transition-all" placeholder="Ej: Juan P칠rez">
               </div>
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Email</label>
                  <input type="email" name="leaderEmail" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:border-brand-teal focus:ring-1 focus:ring-brand-teal outline-none transition-all" placeholder="juan@email.com">
               </div>
               <div>
                  <label class="block text-xs font-bold text-white/60 mb-1 uppercase tracking-wider">Tel칠fono / WhatsApp</label>
                  <input type="tel" name="leaderPhone" required class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/30 focus:border-brand-teal focus:ring-1 focus:ring-brand-teal outline-none transition-all" placeholder="+57 300 123 4567">
               </div>
            </div>
         </div>

         <div class="pt-4 flex justify-end">
            <button type="button" class="btn-next bg-brand-teal text-white px-8 py-3 rounded-xl font-bold hover:brightness-110 transition-all">
               Siguiente &rarr;
            </button>
         </div>
      </div>

      <!-- STEP 2: Group Builder -->
      <div id="step-2" class="step-content hidden space-y-6">
         <h2 class="text-2xl font-bold text-white">Configura tu Grupo</h2>
         <p class="text-white/60 text-sm">Agrega a todas las personas que asistir치n contigo.</p>
         
         <!-- Add Person Form -->
         <div class="bg-white/5 border border-white/10 rounded-xl p-4 space-y-4">
            <div class="grid sm:grid-cols-[2fr_1fr] gap-3">
               <input type="text" id="new-p-name" placeholder="Nombre del asistente" class="bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white outline-none focus:border-brand-teal">
               <select id="new-p-type" class="bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white outline-none focus:border-brand-teal">
                  <option value="ADULT_HOTEL">Adulto (con Hotel)</option>
                  <option value="ADULT_NO_HOTEL">Adulto (sin Hotel)</option>
                  <option value="CHILD_7_13">Ni침o (7-13 a침os)</option>
                  <option value="CHILD_0_7">Ni침o (0-7 a침os)</option>
               </select>
            </div>
            <button type="button" id="btn-add-person" class="w-full py-2 border border-brand-teal text-brand-teal rounded-lg font-bold hover:bg-brand-teal hover:text-white transition-all text-sm uppercase tracking-wide">
               + Agregar Persona
            </button>
         </div>

         <!-- List -->
         <div id="participants-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
            <!-- Items injected by JS -->
            <div class="text-center text-white/30 py-4 italic text-sm" id="empty-msg">No hay participantes a칰n</div>
         </div>

         <div class="pt-4 flex justify-between items-center">
            <button type="button" class="btn-prev text-white/60 hover:text-white underline">
               &larr; Volver
            </button>
            <button type="button" class="btn-next bg-brand-teal text-white px-8 py-3 rounded-xl font-bold hover:brightness-110 transition-all">
               Siguiente &rarr;
            </button>
         </div>
      </div>

      <!-- STEP 3: Payment & Confirm -->
      <div id="step-3" class="step-content hidden space-y-6">
         <h2 class="text-2xl font-bold text-white">Resumen y Pago</h2>
         
         <div class="bg-white/5 rounded-xl p-6 border border-white/10 space-y-4">
            <div class="flex justify-between text-white/70 text-sm">
               <span>Total Grupo:</span>
               <span id="summary-total" class="text-white font-bold text-lg">$0</span>
            </div>
            
            <div class="h-px bg-white/10"></div>
            
            <h3 class="font-bold text-white text-sm uppercase tracking-wide">Opci칩n de Pago</h3>
            <div class="grid grid-cols-2 gap-4">
               <label class="cursor-pointer group">
                  <input type="radio" name="paymentType" value="FULL" class="peer sr-only" checked>
                  <div class="text-center p-4 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Pago Total</span>
                     <span class="block text-xs text-brand-teal mt-1">100%</span>
                  </div>
               </label>
               <label class="cursor-pointer group">
                  <input type="radio" name="paymentType" value="DEPOSIT" class="peer sr-only">
                  <div class="text-center p-4 rounded-xl border border-white/10 bg-black/20 hover:bg-white/5 peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 transition-all">
                     <span class="block font-bold text-white">Abono</span>
                     <span class="block text-xs text-brand-teal mt-1">50%</span>
                  </div>
               </label>
            </div>

            <div class="bg-brand-medium/20 rounded-lg p-3 text-xs text-white/80 flex gap-2 items-start">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-teal flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
               </svg>
               <p>Al hacer clic en "Ir a Pagar", ser치s redirigido a nuestra pasarela segura. No guardamos datos de tarjeta en este sitio.</p>
            </div>
         </div>

         <div class="pt-4 flex justify-between items-center">
            <button type="button" class="btn-prev text-white/60 hover:text-white underline">
               &larr; Volver
            </button>
            <button type="submit" id="btn-pay" class="bg-gradient-to-r from-brand-teal to-[#4CC9E0] text-white px-8 py-4 rounded-xl font-bold shadow-lg w-full md:w-auto hover:scale-105 transition-transform">
               Ir a Pagar <span id="pay-amount-label"></span>
            </button>
         </div>
         <div id="error-msg" class="hidden text-pink-500 text-sm text-center"></div>
      </div>

    </form>
  </div>

  <!-- Right Column: Summary Sticky -->
  <div class="hidden lg:block">
     <div class="sticky top-24 bg-white/5 border border-white/10 rounded-3xl p-6 backdrop-blur-md">
        <h3 class="text-white font-bold mb-4 uppercase tracking-wider text-sm">Tu Inscripci칩n</h3>
        <div id="sidebar-list" class="space-y-2 text-sm text-white/70 mb-4">
           <!-- Dynamic mirror -->
           <p class="italic text-white/30">Agrega participantes para ver el resumen</p>
        </div>
        <div class="border-t border-white/10 pt-4 mt-auto">
           <div class="flex justify-between items-center mb-1">
              <span class="text-white/60">Subtotal</span>
              <span class="text-white font-mono" id="side-subtotal">$0</span>
           </div>
           <div class="flex justify-between items-center text-xl font-bold text-brand-teal">
              <span>Total Estimado</span>
              <span id="side-total">$0</span>
           </div>
        </div>
     </div>
  </div>

</div>

<script>
  // Simple Vanilla JS Logic
  const APP = {
    step: 1,
    participants: [],
    currency: 'COP', // or USD
    countryGroup: 'CO',
    leaderId: 'leader',
    leaderOptOut: false,
    prices: {
       CO: {
          ADULT_HOTEL: 1200000,
          ADULT_NO_HOTEL: 400000,
          CHILD_7_13: 300000,
          CHILD_0_7: 0
       },
       INT: {
          ADULT_HOTEL: 350,
          ADULT_NO_HOTEL: 120,
          CHILD_7_13: 90,
          CHILD_0_7: 0
       }
    },
    
    init() {
       this.cacheDOM();
       this.countryGroup = this.dom.app?.dataset.countryGroup || this.dom.countryInput?.value || 'CO';
       this.bindEvents();
       this.updateCurrency();
    },

    cacheDOM() {
       this.dom = {
          app: document.getElementById('cumbre-form-app'),
          steps: document.querySelectorAll('.step-content'),
          btnsNext: document.querySelectorAll('.btn-next'),
          btnsPrev: document.querySelectorAll('.btn-prev'),
          indicators: document.querySelectorAll('.step-btn'),
          countryInput: document.getElementById('country-group'),
          leaderName: document.querySelector('input[name="leaderName"]'),
          btnAddPerson: document.getElementById('btn-add-person'),
          inputName: document.getElementById('new-p-name'),
          inputType: document.getElementById('new-p-type'),
          list: document.getElementById('participants-list'),
          sidebarList: document.getElementById('sidebar-list'),
          emptyMsg: document.getElementById('empty-msg'),
          totalDisplay: document.getElementById('summary-total'),
          payBtnLabel: document.getElementById('pay-amount-label'),
          form: document.getElementById('booking-form'),
          errorMsg: document.getElementById('error-msg'),
          sideSubtotal: document.getElementById('side-subtotal'),
          sideTotal: document.getElementById('side-total')
       };
    },

    bindEvents() {
       this.dom.btnsNext.forEach(btn => btn.addEventListener('click', () => this.nextStep()));
       this.dom.btnsPrev.forEach(btn => btn.addEventListener('click', () => this.prevStep()));

       this.dom.btnAddPerson.addEventListener('click', () => this.addPerson());
       
       this.dom.form.addEventListener('submit', (e) => this.handleSubmit(e));

       if (this.dom.leaderName) {
          this.dom.leaderName.addEventListener('input', () => this.updateLeaderName());
       }
    },

    nextStep() {
       if(this.step === 1) {
          if(!this.validateStep1()) return;
          this.ensureLeaderParticipant();
          this.renderList();
          this.updateTotals();
       }
       if(this.step === 2 && this.participants.length === 0) {
          alert('Debes agregar al menos un participante');
          return;
       }
       this.step++;
       this.render();
    },

    prevStep() {
       if(this.step > 1) {
          this.step--;
          this.render();
       }
    },

    validateStep1() {
       const fd = new FormData(this.dom.form);
       if(!fd.get('leaderName') || !fd.get('leaderEmail')) {
          alert('Por favor completa los datos del responsable');
          return false;
       }
       return true;
    },

    getLeaderName() {
       return this.dom.leaderName?.value?.trim() || '';
    },

    ensureLeaderParticipant() {
       if (this.leaderOptOut) return;
       const name = this.getLeaderName();
       if (!name) return;

       const existing = this.participants.find(p => p.isLeader);
       if (existing) {
          existing.name = name;
          return;
       }

       const type = this.dom.inputType?.value || 'ADULT_HOTEL';
       this.participants.unshift({ name, type, id: this.leaderId, isLeader: true });
    },

    updateLeaderName() {
       const name = this.getLeaderName();
       if (!name) return;
       const leader = this.participants.find(p => p.isLeader);
       if (!leader) return;
       leader.name = name;
       this.renderList();
    },

    addPerson() {
       const name = this.dom.inputName.value.trim();
       const type = this.dom.inputType.value;
       
       if(!name) return;

       this.participants.push({ name, type, id: Date.now() });
       this.dom.inputName.value = '';
       this.renderList();
       this.updateTotals();
    },

    removePerson(id) {
       const removed = this.participants.find(p => p.id === id);
       if (removed?.isLeader) {
          this.leaderOptOut = true;
       }
       this.participants = this.participants.filter(p => p.id !== id);
       this.renderList();
       this.updateTotals();
    },

    renderList() {
       this.dom.list.innerHTML = '';
       this.dom.sidebarList.innerHTML = '';

       if(this.participants.length === 0) {
          this.dom.list.appendChild(this.dom.emptyMsg);
          this.dom.sidebarList.innerHTML = '<p class="italic text-white/30">Agrega participantes...</p>';
          return;
       }

       this.participants.forEach(p => {
          // Main List Item
          const el = document.createElement('div');
          el.className = 'flex justify-between items-center bg-black/20 p-3 rounded-lg border border-white/5';
          const leaderBadge = p.isLeader
             ? '<span class="ml-2 text-[10px] uppercase tracking-wider text-brand-teal/80">Responsable</span>'
             : '';
          const removeId = JSON.stringify(p.id);
          el.innerHTML = `
             <div>
                <div class="font-bold text-white text-sm">${p.name}${leaderBadge}</div>
                <div class="text-xs text-white/60">${this.getTypeLabel(p.type)}</div>
             </div>
             <button type="button" class="text-pink-400 hover:text-pink-300 text-xs underline p-2" onclick="document.dispatchEvent(new CustomEvent('remove-p', {detail: ${removeId}}))">Eliminar</button>
          `;
          this.dom.list.appendChild(el);

          // Sidebar Item
          const sideEl = document.createElement('div');
          sideEl.className = 'flex justify-between text-xs text-white/80';
          sideEl.innerHTML = `<span>${p.name}</span> <span class="opacity-50">${this.formatPrice(this.getPrice(p.type))}</span>`;
          this.dom.sidebarList.appendChild(sideEl);
       });
    },

    getPrice(type) {
       const map = this.currency === 'COP' ? this.prices.CO : this.prices.INT;
       return map[type] || 0;
    },
    
    getTypeLabel(type) {
        const labels = {
            'ADULT_HOTEL': 'Adulto c/ Hotel',
            'ADULT_NO_HOTEL': 'Adulto s/ Hotel',
            'CHILD_7_13': 'Ni침o (7-13)',
            'CHILD_0_7': 'Ni침o (0-7)'
        };
        return labels[type] || type;
    },

    formatPrice(amount) {
       if(this.currency === 'COP') {
          return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(amount);
       }
       return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(amount);
    },

    updateTotals() {
       const total = this.participants.reduce((sum, p) => sum + this.getPrice(p.type), 0);
       const fmt = this.formatPrice(total);
       this.dom.totalDisplay.textContent = fmt;
       this.dom.sideSubtotal.textContent = fmt;
       this.dom.sideTotal.textContent = fmt;
       this.dom.payBtnLabel.textContent = `(${fmt})`;
    },
    
    updateCurrency() {
        const group = this.dom.countryInput?.value || this.countryGroup || 'CO';
        this.countryGroup = group;
        this.currency = group === 'CO' ? 'COP' : 'USD';
        this.updateTotals();
        this.renderList();
    },

    render() {
       this.dom.steps.forEach(el => el.classList.add('hidden'));
       document.getElementById(`step-${this.step}`).classList.remove('hidden');
       
       this.dom.indicators.forEach((el, idx) => {
          if(idx + 1 === this.step) {
             el.classList.add('active');
             el.querySelector('span').classList.replace('bg-white/10', 'bg-brand-teal');
             el.classList.remove('opacity-50');
          } else if (idx + 1 < this.step) {
             el.classList.add('completed');
             el.classList.remove('opacity-50');
          } else {
             el.classList.remove('active');
             el.querySelector('span').classList.replace('bg-brand-teal', 'bg-white/10');
             el.classList.add('opacity-50');
          }
       });
    },

    async handleSubmit(e) {
       e.preventDefault();
       const fd = new FormData(this.dom.form);
       const data = {
          leader: {
             name: fd.get('leaderName'),
             email: fd.get('leaderEmail'),
             phone: fd.get('leaderPhone'),
             country: fd.get('country')
          },
          participants: this.participants,
          paymentType: fd.get('paymentType'), // FULL or DEPOSIT
          currency: this.currency
       };

       this.dom.errorMsg.classList.add('hidden');
       const btn = document.getElementById('btn-pay');
       const originalText = btn.innerHTML;
       btn.disabled = true;
       btn.innerHTML = 'Procesando...';

       try {
          // MOCK API CALL - Replace with real fetch
          // const res = await fetch('/api/cumbre2026/booking/create', { ... });
          
          await new Promise(r => setTimeout(r, 1500)); // Fake delay
          
          // Redirect to payment URL
          window.location.href = '/eventos/cumbre-mundial-2026/registro?token=demo123&bookingId=555&mock=true';
          
       } catch (err) {
          console.error(err);
          this.dom.errorMsg.textContent = 'Hubo un error al procesar tu solicitud. Intenta nuevamente.';
          this.dom.errorMsg.classList.remove('hidden');
          btn.disabled = false;
          btn.innerHTML = originalText;
       }
    }
  };

  // Event delegation for removal
  document.addEventListener('remove-p', (e) => {
     APP.removePerson(e.detail);
  });

  // Init
  window.addEventListener('DOMContentLoaded', () => APP.init());

</script>
