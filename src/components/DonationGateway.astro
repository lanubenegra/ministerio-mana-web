---
import type { FxSnapshot } from '@lib/fx';
import { convertAmount, formatCurrency } from '@lib/fx';
import { displayCurrencyOrder } from '@lib/geo';
import TurnstileWidget from './TurnstileWidget.astro';
import donationScript from '../scripts/donation-gateway.ts?url';

interface Props {
  preferred: 'wompi' | 'stripe';
  rates: FxSnapshot;
  country?: string;
}

const { preferred, rates, country } = Astro.props as Props;
const secondary = preferred === 'wompi' ? 'stripe' : 'wompi';
const order = displayCurrencyOrder(country).filter((code) => rates.rates[code as keyof typeof rates.rates]);
const conversionOrder = order.slice(0, 8);
const usdDefault = 20;
const defaultWompiAmount = 50000;
const conversions = conversionOrder.map((currency) => {
  if (currency === 'USD') return { currency, formatted: formatCurrency(usdDefault, 'USD') };
  const value = convertAmount(usdDefault, 'USD', currency as any, rates.rates);
  return { currency, formatted: formatCurrency(value, currency as any) };
});
const providerName = rates.provider === 'openexchangerates' ? 'Open Exchange Rates' : 'ExchangeRate.host';
const localeMap: Record<string, string> = {
  USD: 'en-US',
  COP: 'es-CO',
  MXN: 'es-MX',
  PEN: 'es-PE',
  ARS: 'es-AR',
  CLP: 'es-CL',
  BRL: 'pt-BR',
  UYU: 'es-UY',
  PYG: 'es-PY',
  BOB: 'es-BO',
  CRC: 'es-CR',
  GTQ: 'es-GT',
  HNL: 'es-HN',
  NIO: 'es-NI',
  DOP: 'es-DO',
  BZD: 'en-BZ',
  CAD: 'en-CA',
  AUD: 'en-AU',
  EUR: 'es-ES',
  GBP: 'en-GB'
};

const cspNonce = Astro.locals?.cspNonce;
const configPayload = JSON.stringify({ rates: rates.rates, locales: localeMap });
const wompiPlaceholder = `Ej. ${formatCurrency(defaultWompiAmount, 'COP')}`;
const primaryCurrency = order[0] ?? 'USD';
const stripeLocalExample = primaryCurrency === 'USD'
  ? formatCurrency(usdDefault, 'USD')
  : formatCurrency(convertAmount(usdDefault, 'USD', primaryCurrency as any, rates.rates), primaryCurrency as any);
const stripePlaceholder = `Ej. ${stripeLocalExample} (se procesa en USD)`;
---
<section class="space-y-6" data-donation-gateway data-donation-config={configPayload}>
  <p class="text-sm text-neutral-500">
    Detectamos que te encuentras en <strong>{country || 'tu país'}</strong>. Te sugerimos esta opción:
  </p>
  <div class="grid gap-5 lg:grid-cols-2">
    <div class={`rounded-3xl border bg-[var(--mana-surface)] p-5 ${preferred === 'wompi' ? 'border-brand-medium shadow-brand/40' : 'border-brand-medium shadow-brand/40'}`}>
      {preferred === 'wompi' ? (
        <>
          <header class="space-y-1 mb-3">
            <span class="pill bg-brand-medium/20 text-brand-dark">Recomendado</span>
            <h3 class="text-lg font-display text-brand-dark">Pagos en Colombia (COP)</h3>
            <p class="text-sm text-neutral-600">Procesado con Wompi para cuentas bancarias colombianas.</p>
          </header>
          <form method="POST" action="/api/wompi/checkout" class="space-y-4" novalidate>
            <input type="hidden" name="country" value={country ?? ''} />
            <label class="text-sm block">
              Valor (COP) — ingresa tu donación en pesos colombianos
              <input type="number" name="amount" class="mt-1 w-full rounded border-gray-300" placeholder={wompiPlaceholder} min="5000" step="1000" required />
            </label>
            <label class="text-sm block">
              Descripción
              <input type="text" name="desc" class="mt-1 w-full rounded border-gray-300" placeholder="Donación general" />
            </label>
            <TurnstileWidget />
            <button class="btn-primary w-full justify-center normal-case" type="submit">Donar con Wompi</button>
          </form>
        </>
      ) : (
        <>
          <header class="space-y-1 mb-3">
            <span class="pill bg-brand-medium/20 text-brand-dark">Recomendado</span>
            <h3 class="text-lg font-display text-brand-dark">Pagos internacionales (USD)</h3>
            <p class="text-sm text-neutral-600">Procesado con Stripe. El cargo final se realiza en USD.</p>
          </header>
          <form method="POST" action="/api/stripe/checkout" class="space-y-4" novalidate>
            <input type="hidden" name="currency" value="USD" />
            <input type="hidden" name="country" value={country ?? ''} />
            <label class="text-sm block">
              Monto (USD) — Stripe convierte desde tu moneda al cerrar el pago
              <input type="number" name="amountUsd" class="mt-1 w-full rounded border-gray-300" placeholder={stripePlaceholder} min="5" step="1" value="20" required data-usd-input />
            </label>
            <label class="text-sm block">
              Descripción
              <input type="text" name="desc" class="mt-1 w-full rounded border-gray-300" placeholder="Donation" />
            </label>
            <TurnstileWidget />
            <button class="btn-primary w-full justify-center normal-case" type="submit">Donate with Stripe</button>
          </form>
          <div class="mt-4 space-y-1">
            <p class="text-xs font-semibold text-neutral-500">Equivalencia aproximada:</p>
            <ul class="text-xs space-y-1 text-neutral-500">
              {conversions.map((item) => (
                <li data-conversion data-currency={item.currency}>{item.formatted}</li>
              ))}
            </ul>
          </div>
        </>
      )}
    </div>

    <div class="rounded-3xl border border-[var(--mana-border)] bg-[var(--mana-surface)] p-5 shadow-sm">
      <details>
        <summary class="cursor-pointer text-sm font-semibold text-brand-dark">¿Quieres usar otra pasarela?</summary>
        <div class="mt-4 space-y-4">
          {secondary === 'wompi' ? (
            <div class="rounded-3xl border border-[var(--mana-border)] bg-white/70 p-4">
              <header class="space-y-1 mb-3">
                <span class="pill">Alternativa</span>
                <h3 class="text-base font-display text-brand-dark">Pagos en Colombia (COP)</h3>
                <p class="text-sm text-neutral-600">Disponible para cuentas bancarias colombianas.</p>
              </header>
              <form method="POST" action="/api/wompi/checkout" class="space-y-4" novalidate>
                <input type="hidden" name="country" value={country ?? ''} />
                <label class="text-sm block">
                  Valor (COP) — ingresa tu donación en pesos colombianos
                  <input type="number" name="amount" class="mt-1 w-full rounded border-gray-300" placeholder={wompiPlaceholder} min="5000" step="1000" required />
                </label>
                <label class="text-sm block">
                  Descripción
                  <input type="text" name="desc" class="mt-1 w-full rounded border-gray-300" placeholder="Donación general" />
                </label>
                <TurnstileWidget />
                <button class="btn-outline w-full justify-center normal-case" type="submit">Donar con Wompi</button>
              </form>
            </div>
          ) : (
            <div class="rounded-3xl border border-[var(--mana-border)] bg-white/70 p-4">
              <header class="space-y-1 mb-3">
                <span class="pill">Alternativa</span>
                <h3 class="text-base font-display text-brand-dark">Pagos internacionales (USD)</h3>
                <p class="text-sm text-neutral-600">Stripe permite tarjetas de todo el mundo.</p>
              </header>
              <form method="POST" action="/api/stripe/checkout" class="space-y-4" novalidate>
                <input type="hidden" name="currency" value="USD" />
                <input type="hidden" name="country" value={country ?? ''} />
                <label class="text-sm block">
                  Monto (USD) — Stripe convierte desde tu moneda al cerrar el pago
                  <input type="number" name="amountUsd" class="mt-1 w-full rounded border-gray-300" placeholder={stripePlaceholder} min="5" step="1" value="20" required data-usd-input />
                </label>
                <label class="text-sm block">
                  Descripción
                  <input type="text" name="desc" class="mt-1 w-full rounded border-gray-300" placeholder="Donation" />
                </label>
                <TurnstileWidget />
                <button class="btn-outline w-full justify-center normal-case" type="submit">Donate with Stripe</button>
              </form>
              <div class="mt-4 space-y-1">
                <p class="text-xs font-semibold text-neutral-500">Equivalencia aproximada:</p>
                <ul class="text-xs space-y-1 text-neutral-500">
                  {conversions.map((item) => (
                    <li data-conversion data-currency={item.currency}>{item.formatted}</li>
                  ))}
                </ul>
              </div>
            </div>
          )}
        </div>
      </details>
    </div>
  </div>
  <p class="text-xs text-neutral-500">
    Tasas de referencia obtenidas de <span class="font-medium">{providerName}</span> ({new Date(rates.timestamp).toLocaleString('es-CO')}). Tu transacción final se procesa en la moneda oficial de la pasarela.
  </p>
</section>

<script type="module" src={donationScript} defer nonce={cspNonce}></script>
