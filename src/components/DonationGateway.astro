---
import TurnstileWidget from '@components/TurnstileWidget.astro';

type Gateway = 'wompi' | 'stripe';

interface Props {
  preferred?: Gateway;
  country?: string;
  rates?: any;
}

const { preferred = 'wompi', country = 'CO', rates } = Astro.props as Props;
const isWompi = preferred === 'wompi';
const cspNonce = Astro.locals?.cspNonce;

// Si tienes snapshot de tasas, puedes sacar algo de ahí
const copPerUsd: number | null =
  (rates && (rates.COP ?? rates?.rates?.COP)) || null;
---

<section class="container-tight py-10 space-y-6">
  <header class="space-y-2">
    <p class="text-sm uppercase tracking-[0.2em] text-sky-600">
      Donaciones seguras
    </p>
    <h1 class="h1">Pagos y donaciones</h1>
    <p class="text-base text-slate-600 max-w-3xl">
      Todo nuestro lenguaje es donaciones: das con generosidad y recibes los
      recursos (libros, agenda, inscripciones) como agradecimiento.
    </p>
    {country && (
      <p class="text-xs text-slate-500 mt-2">
        Detectamos que te encuentras en <span class="font-semibold">{country}</span>. Te
        sugerimos esta opción:
      </p>
    )}
    {copPerUsd && (
      <p class="text-xs text-slate-400 mt-1">
        Referencia de cambio: <span class="font-mono">1 USD ≈ {copPerUsd.toLocaleString('es-CO')} COP</span>
        (solo informativo, la tasa final la define la pasarela).
      </p>
    )}
  </header>

  <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 md:p-8 space-y-6">
    <!-- Radios invisibles para cambiar de pasarela sin JS -->
    <input
      type="radio"
      id="gw-wompi"
      name="gateway"
      class="peer/gw-wompi hidden"
      checked={isWompi}
    />
    <input
      type="radio"
      id="gw-stripe"
      name="gateway"
      class="peer/gw-stripe hidden"
      checked={!isWompi}
    />

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2">
      <label
        for="gw-wompi"
        class="cursor-pointer px-4 py-1.5 text-sm rounded-full border
               peer-checked/gw-wompi:bg-sky-600 peer-checked/gw-wompi:text-white
               peer-checked/gw-wompi:border-sky-600 border-slate-200 text-slate-700"
      >
        Pagos en Colombia (COP)
      </label>
      <label
        for="gw-stripe"
        class="cursor-pointer px-4 py-1.5 text-sm rounded-full border
               peer-checked/gw-stripe:bg-indigo-600 peer-checked/gw-stripe:text-white
               peer-checked/gw-stripe:border-indigo-600 border-slate-200 text-slate-700"
      >
        Pagos internacionales (USD)
      </label>
    </div>

    <!-- Paneles -->
    <div class="space-y-6">
      <!-- Panel Wompi -->
      <div class="gw-panel gw-panel-wompi">
        <p class="text-xs font-medium text-sky-600 mb-1">Recomendado</p>
        <p class="font-semibold text-slate-900">
          Pagos en Colombia (COP)
        </p>
        <p class="text-sm text-slate-600 mb-4">
          Procesado con Wompi para cuentas bancarias colombianas.
        </p>

        <form
          method="POST"
          action="/api/wompi/checkout"
          class="space-y-4"
        >
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Nombre completo
            </label>
            <input
              type="text"
              name="fullName"
              required
              placeholder="Nombre y apellido"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Correo
            </label>
            <input
              type="email"
              name="email"
              required
              placeholder="tucorreo@email.com"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Teléfono / WhatsApp
            </label>
            <input
              type="text"
              name="phone"
              required
              placeholder="3000000000"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
            />
          </div>

          <div class="hidden grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Tipo de documento
              </label>
              <select
                name="documentType"
                required
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              >
                <option value="" disabled selected>Selecciona</option>
                <option value="CC">CC</option>
                <option value="CE">CE</option>
                <option value="NIT">NIT</option>
                <option value="TI">TI</option>
                <option value="PAS">Pasaporte</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Número de documento
              </label>
              <input
                type="text"
                name="documentNumber"
                required
                placeholder="Documento"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                País
              </label>
              <input
                type="text"
                name="country"
                required
                value="CO"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Ciudad
              </label>
              <input
                type="text"
                name="city"
                required
                placeholder="Ciudad"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Iglesia
              </label>
              <input
                type="text"
                name="church"
                required
                placeholder="Iglesia o sede"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Campus
              </label>
              <input
                type="text"
                name="campus"
                placeholder="Campus Maná"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Tipo de donación
              </label>
              <select
                name="donationType"
                required
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              >
                <option value="" disabled selected>Selecciona</option>
                <option value="diezmos">Diezmos</option>
                <option value="ofrendas">Ofrendas</option>
                <option value="misiones">Misiones</option>
                <option value="campus">Campus</option>
                <option value="evento">Evento</option>
                <option value="general">General</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Proyecto
              </label>
              <input
                type="text"
                name="projectName"
                required
                placeholder="Proyecto"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Evento
            </label>
            <input
              type="text"
              name="eventName"
              required
              placeholder="Evento"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Valor (COP) – ingresa tu donación en pesos colombianos
            </label>
            <input
              type="number"
              name="amount"
              min="1000"
              step="1000"
              required
              placeholder="Ej. 50000"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Descripción
            </label>
            <input
              type="text"
              name="description"
              placeholder="Donación general, Devocional, Campus, etc."
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
            />
          </div>

          <!-- Campos ocultos básicos -->
          <input type="hidden" name="currency" value="COP" />
          <input type="hidden" name="source" value="donaciones-wompi" />

          <!-- Turnstile (aparecerá cuando haya llave configurada) -->
          <TurnstileWidget appearance="always" theme="auto" />

          <button
            type="submit"
            class="mt-4 inline-flex w-full items-center justify-center rounded-full
                   bg-gradient-to-r from-sky-600 via-indigo-600 to-pink-500
                   px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-sky-500/20
                   hover:brightness-105 transition"
          >
            Donar con Wompi
          </button>

          <p class="mt-2 text-[11px] text-slate-400">
            Tu pago se procesa en la pasarela segura de Wompi. No almacenamos datos de tarjeta.
          </p>
        </form>
      </div>

      <!-- Panel Stripe -->
      <div class="gw-panel gw-panel-stripe">
        <p class="font-semibold text-slate-900">
          Pagos internacionales (USD)
        </p>
        <p class="text-sm text-slate-600 mb-4">
          Procesado con Stripe para donaciones desde el exterior.
        </p>

        <form
          method="POST"
          action="/api/stripe/checkout"
          class="space-y-4"
        >
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Nombre completo
            </label>
            <input
              type="text"
              name="fullName"
              required
              placeholder="Nombre y apellido"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Correo
            </label>
            <input
              type="email"
              name="email"
              required
              placeholder="tucorreo@email.com"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Teléfono / WhatsApp
            </label>
            <input
              type="text"
              name="phone"
              required
              placeholder="+1 555 000 0000"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
            />
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Tipo de documento
              </label>
              <select
                name="documentType"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              >
                <option value="" selected>Selecciona</option>
                <option value="PAS">Pasaporte</option>
                <option value="NID">ID nacional</option>
                <option value="DL">Licencia de conducir</option>
                <option value="OTRO">Otro</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Número de documento
              </label>
              <input
                type="text"
                name="documentNumber"
                placeholder="Documento"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              />
            </div>
          </div>

          <div class="hidden flex items-center gap-2">
            <input
              type="checkbox"
              id="stripe-need-certificate"
              name="needCertificate"
              class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
            />
            <label for="stripe-need-certificate" class="text-sm text-slate-600">
              Necesito certificado
            </label>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                País
              </label>
              <input
                type="text"
                name="country"
                required
                placeholder="US, ES, CO..."
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Ciudad
              </label>
              <input
                type="text"
                name="city"
                required
                placeholder="Ciudad"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Iglesia
              </label>
              <input
                type="text"
                name="church"
                required
                placeholder="Iglesia o sede"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Campus
              </label>
              <input
                type="text"
                name="campus"
                placeholder="Campus Maná"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              />
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Tipo de donación
              </label>
              <select
                name="donationType"
                required
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              >
                <option value="" disabled selected>Selecciona</option>
                <option value="diezmos">Diezmos</option>
                <option value="ofrendas">Ofrendas</option>
                <option value="misiones">Misiones</option>
                <option value="campus">Campus</option>
                <option value="evento">Evento</option>
                <option value="general">General</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Proyecto
              </label>
              <input
                type="text"
                name="projectName"
                required
                placeholder="Proyecto"
                class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                       focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Evento
            </label>
            <input
              type="text"
              name="eventName"
              required
              placeholder="Evento"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Monto (USD)
            </label>
            <input
              type="number"
              name="amount"
              min="5"
              step="1"
              required
              placeholder="Ej. 50"
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Propósito de la donación
            </label>
            <input
              type="text"
              name="description"
              placeholder="Devocional Maná, Campus Maná, Mujeres que creen..."
              class="w-full rounded-2xl border border-slate-200 px-4 py-2.5 text-sm
                     focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400"
            />
          </div>

          <!-- Campos ocultos básicos -->
          <input type="hidden" name="currency" value="USD" />
          <input type="hidden" name="source" value="donaciones-stripe" />

          <!-- Turnstile -->
          <TurnstileWidget appearance="always" theme="auto" />

          <button
            type="submit"
            class="mt-4 inline-flex w-full items-center justify-center rounded-full
                   bg-gradient-to-r from-indigo-600 via-sky-600 to-teal-500
                   px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-500/20
                   hover:brightness-105 transition"
          >
            Donar con tarjeta internacional
          </button>

          <p class="mt-2 text-[11px] text-slate-400">
            Stripe procesa tu donación de forma segura. Nosotros sólo recibimos la confirmación.
          </p>
        </form>
      </div>
    </div>
  </div>

  <p class="text-xs text-slate-500 max-w-3xl">
    Emitimos reportes y exportaciones (CSV/Excel) para contabilidad y DIAN; pedimos número de
    identificación según país. Las donaciones desde el exterior se registran con los datos que
    ingresas en Stripe.
  </p>
</section>

<style is:inline>
  /* Mostrar/ocultar paneles según el radio seleccionado sin usar JS */
  .gw-panel {
    display: none;
  }

  #gw-wompi:checked ~ .space-y-6 .gw-panel-wompi {
    display: block;
  }
  #gw-stripe:checked ~ .space-y-6 .gw-panel-stripe {
    display: block;
  }

  /* Fallback: si por lo que sea no se aplica el selector, mostramos siempre ambos stacked */
  @supports not (#gw-wompi:checked ~ .space-y-6 .gw-panel-wompi) {
    .gw-panel {
      display: block;
    }
  }
</style>

<script nonce={cspNonce}>
  const wompiForm = document.querySelector('form[action="/api/wompi/checkout"]');
  const stripeForm = document.querySelector('form[action="/api/stripe/checkout"]');
  let portalProfileCache = null;
  const DEFAULT_CHURCH = 'Ministerio Maná Virtual';

  function getSupabaseAccessToken() {
    try {
      const key = Object.keys(localStorage).find((k) => k.startsWith('sb-') && k.endsWith('-auth-token'));
      if (!key) return null;
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const session = JSON.parse(raw);
      return session?.access_token || null;
    } catch (err) {
      return null;
    }
  }

  function setValueIfEmpty(el, value) {
    if (!el || !value) return;
    if (el.value) return;
    el.value = value;
  }

  function ensureVirtualChurch(form) {
    if (!form) return;
    const churchInput = form.querySelector('input[name="church"]');
    const campusInput = form.querySelector('input[name="campus"]');
    const hasCampus = campusInput?.value?.trim();
    if (churchInput && !churchInput.value.trim() && !hasCampus) {
      churchInput.value = DEFAULT_CHURCH;
    }
  }

  function setDocumentRequired(form, required) {
    if (!form) return;
    const docType = form.querySelector('select[name="documentType"]');
    const docNumber = form.querySelector('input[name="documentNumber"]');
    if (docType) docType.required = Boolean(required);
    if (docNumber) docNumber.required = Boolean(required);
  }

  function updateStripeDocumentRequirement() {
    if (!stripeForm) return;
    setDocumentRequired(stripeForm, false);
  }

  function fillDonationForm(form, profile) {
    if (!form || !profile) return;
    setValueIfEmpty(form.querySelector('input[name="fullName"]'), profile.full_name);
    setValueIfEmpty(form.querySelector('input[name="email"]'), profile.email);
    setValueIfEmpty(form.querySelector('input[name="phone"]'), profile.phone);
    setValueIfEmpty(form.querySelector('input[name="city"]'), profile.city);
    setValueIfEmpty(form.querySelector('input[name="church"]'), profile.church_name);

    const docType = form.querySelector('select[name="documentType"]');
    if (docType && !docType.value && profile.document_type) {
      docType.value = profile.document_type;
    }
    setValueIfEmpty(form.querySelector('input[name="documentNumber"]'), profile.document_number);

    const countryInput = form.querySelector('input[name="country"]');
    if (countryInput && !countryInput.value && profile.country) {
      countryInput.value = profile.country;
    }
  }

  function resolveValue(form, selector, fallback) {
    const el = form?.querySelector(selector);
    const value = el?.value?.trim();
    return value || fallback || '';
  }

  function saveProfileFromDonation(form) {
    if (!form || !portalProfileCache) return;
    ensureVirtualChurch(form);
    const token = getSupabaseAccessToken();
    if (!token) return;

    const payload = {
      fullName: resolveValue(form, 'input[name="fullName"]', portalProfileCache.full_name),
      phone: resolveValue(form, 'input[name="phone"]', portalProfileCache.phone),
      city: resolveValue(form, 'input[name="city"]', portalProfileCache.city),
      country: resolveValue(form, 'input[name="country"]', portalProfileCache.country),
      documentType: resolveValue(form, 'select[name="documentType"]', portalProfileCache.document_type),
      documentNumber: resolveValue(form, 'input[name="documentNumber"]', portalProfileCache.document_number),
      churchName: resolveValue(form, 'input[name="church"]', portalProfileCache.church_name),
      affiliationType: portalProfileCache.affiliation_type || '',
      churchId: portalProfileCache.church_id || null,
    };

    try {
      fetch('/api/portal/profile', {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
        keepalive: true,
        credentials: 'include',
      }).catch(() => {});
    } catch (err) {
      // Non-blocking update; ignore errors here.
    }
  }

  async function prefillFromPortalProfile() {
    const token = getSupabaseAccessToken();
    if (!token) return;
    try {
      const res = await fetch('/api/portal/session', {
        headers: { Authorization: `Bearer ${token}` },
        credentials: 'include',
      });
      const payload = await res.json().catch(() => null);
      if (!res.ok || !payload?.ok) return;
      const profile = payload.profile || {};
      portalProfileCache = profile;
      fillDonationForm(wompiForm, profile);
      fillDonationForm(stripeForm, profile);
    } catch (err) {
      console.warn('[donaciones] No se pudo precargar perfil');
    }
  }

  prefillFromPortalProfile();
  ensureVirtualChurch(wompiForm);
  ensureVirtualChurch(stripeForm);
  updateStripeDocumentRequirement();
  wompiForm?.addEventListener('submit', () => saveProfileFromDonation(wompiForm));
  stripeForm?.addEventListener('submit', () => saveProfileFromDonation(stripeForm));
</script>
