---
// This component detects if user has an active session
// Shows "Iniciar sesión" for guests or account dropdown for logged users
---

<div id="account-button-container" class="relative">
  <!-- Loading state -->
  <div id="account-loading" class="w-8 h-8 rounded-full bg-neutral-100 animate-pulse"></div>
  
  <!-- Guest state: Show login button -->
  <a 
    id="account-guest" 
    href="/cuenta/ingresar" 
    class="hidden items-center gap-2 px-4 py-2 rounded-full border border-[var(--mana-border)] hover:border-brand-medium hover:bg-brand-teal/5 transition-all text-sm font-medium text-neutral-700 hover:text-brand-dark"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
    </svg>
    <span class="hidden sm:inline">Iniciar sesión</span>
  </a>
  
  <!-- Logged state: Show account button -->
  <details id="account-logged" class="hidden relative">
    <summary class="flex items-center gap-2 px-4 py-2 rounded-full border border-[var(--mana-border)] hover:border-brand-medium hover:bg-brand-teal/5 transition-all cursor-pointer select-none">
      <div class="w-8 h-8 rounded-full bg-brand-teal/10 flex items-center justify-center text-brand-dark font-bold text-sm">
        <span id="account-initials">U</span>
      </div>
      <span id="account-name" class="hidden sm:inline text-sm font-medium text-neutral-700"></span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </summary>
    
    <div class="absolute right-0 mt-3 w-56 rounded-2xl border border-[var(--mana-border-strong)] bg-[var(--mana-surface)] p-2 shadow-lg z-50">
      <a href="/cuenta/" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-neutral-50 text-neutral-700 hover:text-brand-dark transition-colors text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
        Mi Cuenta
      </a>
      <hr class="my-2 border-[var(--mana-border)]" />
      <button id="btn-logout-header" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 text-red-600 hover:text-red-700 transition-colors text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
        </svg>
        Cerrar sesión
      </button>
    </div>
  </details>
</div>

<script type="module">
  import { getSupabaseBrowserClient } from '@lib/supabaseBrowser';
  
  const container = document.getElementById('account-button-container');
  const loading = document.getElementById('account-loading');
  const guestBtn = document.getElementById('account-guest');
  const loggedBtn = document.getElementById('account-logged');
  const accountName = document.getElementById('account-name');
  const accountInitials = document.getElementById('account-initials');
  const logoutBtn = document.getElementById('btn-logout-header');
  
  const supabase = getSupabaseBrowserClient();
  
  async function checkSession() {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (loading) loading.classList.add('hidden');
      
      if (session?.user) {
        // User is logged in
        const userName = session.user.user_metadata?.full_name || session.user.email?.split('@')[0] || 'Usuario';
        const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        
        if (accountName) accountName.textContent = userName.split(' ')[0]; // First name only
        if (accountInitials) accountInitials.textContent = initials;
        
        if (guestBtn) guestBtn.classList.add('hidden');
        if (loggedBtn) loggedBtn.classList.remove('hidden');
      } else {
        // User is not logged in
        if (loggedBtn) loggedBtn.classList.add('hidden');
        if (guestBtn) guestBtn.classList.remove('hidden');
        guestBtn.classList.add('flex');
      }
    } catch (err) {
      console.error('Error checking session:', err);
      // On error, show guest button
      if (loading) loading.classList.add('hidden');
      if (loggedBtn) loggedBtn.classList.add('hidden');
      if (guestBtn) {
        guestBtn.classList.remove('hidden');
        guestBtn.classList.add('flex');
      }
    }
  }
  
  // Handle logout
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      logoutBtn.disabled = true;
      logoutBtn.textContent = 'Saliendo...';
      await supabase.auth.signOut();
      window.location.href = '/';
    });
  }
  
  checkSession();
</script>
