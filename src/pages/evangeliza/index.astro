---
import BaseLayout from '@layouts/BaseLayout.astro';
import EvangelizaHeatmap from '@components/EvangelizaHeatmap.astro';
import PrayerWall from '@components/PrayerWall.astro';
import TurnstileWidget from '@components/TurnstileWidget.astro';

const cspNonce = Astro.locals?.cspNonce;
---

<BaseLayout
  title="Evangeliza 췅 Ministerio Man치"
  description="Reto permanente de evangelizaci칩n: registra a qui칠n compartiste de Cristo y ora por su vida."
>
  <section class="container-tight py-10 space-y-8">
    <header class="space-y-3 max-w-3xl">
      <p class="eyebrow">Evangeliza</p>
      <h1 class="h1">Compartimos a Jes칰s, contamos las historias</h1>
      <p class="lead">
        Registra el nombre de la persona a quien compartiste de Cristo y 칰nete al reto global de evangelizaci칩n del Ministerio Man치.
      </p>
    </header>

    <form id="evangeliza-form" class="space-y-4 max-w-xl">
      <div>
        <label class="label" for="name">Nombre de la persona</label>
        <input
          id="name"
          name="firstName"
          type="text"
          required
          class="input"
          placeholder="Solo el primer nombre (ej. Carlos)"
        />
      </div>
      <div>
        <label class="label" for="city">Ciudad / pa칤s (opcional)</label>
        <input
          id="city"
          name="city"
          type="text"
          class="input"
          placeholder="Medell칤n, Colombia"
        />
      </div>
      <TurnstileWidget />
      <button
        type="submit"
        class="btn-primary w-full sm:w-auto"
      >
        Sumar evangelizaci칩n
      </button>
      <p id="evangeliza-status" class="text-xs text-slate-500"></p>
      <p class="text-xs text-slate-500">Solo usamos el primer nombre para orar y sumar en el mapa.</p>
    </form>

    <section class="space-y-4">
      <h2 class="h2">Mapa de evangelizaci칩n</h2>
      <p class="text-slate-600 text-sm">
        Cada punto representa personas por las que estamos orando. Es una vista de fe, no un mapa exacto de datos personales.
      </p>
      <EvangelizaHeatmap />
    </section>

    <section class="mt-10 space-y-6">
      <h2 class="h2">Ora con nosotros</h2>
      <PrayerWall />
    </section>
  </section>

  <script is:inline nonce={cspNonce}>
    (() => {
      if (typeof window === 'undefined') return;
      const form = document.getElementById('evangeliza-form');
      if (!form) return;

      const statusEl = document.getElementById('evangeliza-status');

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const data = new FormData(form);

        if (statusEl) {
          statusEl.textContent = 'Enviando...';
          statusEl.className = 'text-sm text-slate-600';
        }

        try {
          const res = await fetch('/api/evangeliza/submit', {
            method: 'POST',
            body: data,
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Error al registrar');
          }
          const json = await res.json().catch(() => ({ ok: true }));

          form.reset();
          if (statusEl) {
            statusEl.textContent = 'Gracias, a침adimos esta persona para orar 游똂';
            statusEl.className = 'text-sm font-semibold text-emerald-700';
          } else {
            alert('Gracias, a침adimos esta persona para orar 游똂');
          }

          if (json?.point && window.addEvangelizaPoint) {
            window.addEvangelizaPoint(json.point);
          }
        } catch (err) {
          console.error(err);
          if (statusEl) {
            statusEl.textContent = 'No pudimos registrar ahora. Intenta de nuevo m치s tarde.';
            statusEl.className = 'text-sm font-semibold text-rose-700';
          } else {
            alert('No pudimos registrar ahora. Intenta de nuevo m치s tarde.');
          }
        }
      });
    })();
  </script>
</BaseLayout>
