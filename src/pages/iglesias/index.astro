---
export const prerender = false;
import BaseLayout from '@layouts/BaseLayout.astro';
import ChurchesMap from '@components/ChurchesMap.astro';
import churchesData from '@data/churches.json';

const churchesRaw = (churchesData as any[]).map((c) => ({
  ...c,
  country: c.country ?? 'Colombia',
}));
const churches = churchesRaw.sort((a, b) => (a.city || '').localeCompare(b.city || ''));
const countries = Array.from(new Set(churches.map((c) => c.country))).sort();
const cspNonce = Astro.locals?.cspNonce;
---
<BaseLayout title="Iglesias — Planea tu visita" description="Encuentra la sede de Maná más cercana y planea tu visita.">
  <section class="section">
    <h1 class="h1 mb-6">Iglesias · Planea tu visita</h1>
    <p class="mb-4">Mapa interactivo con nuestras sedes. Cada pin abre opciones de <em>Cómo llegar</em> y contacto directo por WhatsApp.</p>
    <ChurchesMap />

    <div class="mt-10 space-y-4">
      <div class="flex flex-wrap gap-3 items-end">
        <label class="flex-1 min-w-[220px]">
          <span class="label text-xs font-semibold text-slate-600">Buscar ciudad o iglesia</span>
          <input id="churches-search" type="search" class="input" placeholder="Ej: Medellín, Bogotá, Cali" />
        </label>
        <label class="w-full sm:w-[220px]">
          <span class="label text-xs font-semibold text-slate-600">País</span>
          <select id="churches-country" class="input">
            <option value="">Todos</option>
            {countries.map((country) => (
              <option value={country}>{country}</option>
            ))}
          </select>
        </label>
        <div class="text-sm text-slate-500 pb-2 sm:pb-0">
          <span id="churches-count">{churches.length}</span> sedes
        </div>
      </div>

      <div id="churches-grid" class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        {churches.map((c) => (
          <article
            class="rounded-2xl border border-slate-200 bg-white shadow-sm p-4 space-y-2"
            data-city={c.city}
            data-country={c.country}
            data-name={c.name}
            data-address={c.address}
          >
            <p class="text-xs font-semibold uppercase tracking-[0.12em] text-slate-500">{c.country}</p>
            <div>
              <p class="text-sm font-semibold text-slate-700">{c.city}</p>
              <h3 class="text-lg font-semibold text-slate-900">{c.name}</h3>
            </div>
            <p class="text-sm text-slate-600">{c.address ?? 'Dirección por confirmar'}</p>
            {c.notes && <p class="text-xs text-amber-700 bg-amber-50 rounded-full px-3 py-1 inline-block">{c.notes}</p>}
            <div class="text-sm text-slate-700 space-y-1">
              {c.contact?.name && <div>Contacto: <span class="font-semibold">{c.contact.name}</span></div>}
              {c.contact?.phone && (
                <div>Tel: <a class="text-sky-700 hover:underline" href={`tel:${c.contact.phone}`}>{c.contact.phone}</a></div>
              )}
              {c.whatsapp && (
                <div>WhatsApp: <a class="text-sky-700 hover:underline" href={`https://wa.me/${c.whatsapp.replace(/[^\\d]/g, '')}`} target="_blank" rel="noopener noreferrer">{c.whatsapp}</a></div>
              )}
              {c.contact?.email && (
                <div>Email: <a class="text-sky-700 hover:underline" href={`mailto:${c.contact.email}`}>{c.contact.email}</a></div>
              )}
            </div>
            <div class="pt-2 flex flex-wrap gap-2">
              {c.whatsapp && (
                <a
                  class="btn-primary btn-sm inline-flex items-center"
                  href={`https://wa.me/${c.whatsapp.replace(/[^\\d]/g, '')}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Escribir por WhatsApp
                </a>
              )}
              {typeof c.lat === 'number' && typeof c.lng === 'number' && (
                <a
                  class="btn-outline btn-sm inline-flex items-center"
                  href={`https://www.google.com/maps?q=${c.lat},${c.lng}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Cómo llegar
                </a>
              )}
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

  <script is:inline nonce={cspNonce}>
    (() => {
      const searchInput = document.getElementById('churches-search');
      const countrySelect = document.getElementById('churches-country');
      const cards = Array.from(document.querySelectorAll('#churches-grid [data-city]')) as HTMLElement[];
      const countEl = document.getElementById('churches-count');

      function normalize(str: string) {
        return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      }

      function filter() {
        const term = normalize((searchInput as HTMLInputElement).value || '');
        const country = (countrySelect as HTMLSelectElement).value;
        let visible = 0;

        cards.forEach((card) => {
          const city = normalize(card.dataset.city || '');
          const name = normalize(card.dataset.name || '');
          const address = normalize(card.dataset.address || '');
          const rowCountry = card.dataset.country || '';

          const matchesText = !term || city.includes(term) || name.includes(term) || address.includes(term);
          const matchesCountry = !country || rowCountry === country;
          const show = matchesText && matchesCountry;
          card.style.display = show ? '' : 'none';
          if (show) visible += 1;
        });

        if (countEl) countEl.textContent = String(visible);
      }

      if (searchInput) searchInput.addEventListener('input', filter);
      if (countrySelect) countrySelect.addEventListener('change', filter);
    })();
  </script>
</BaseLayout>
