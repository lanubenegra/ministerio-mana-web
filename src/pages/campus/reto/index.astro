---
import BaseLayout from '@layouts/BaseLayout.astro';
const cspNonce = Astro.locals?.cspNonce;
---
<BaseLayout title="Reto de Campus · 7 conversaciones" description="Cada semana, metas de 7 conversaciones por campus.">
  <section class="section grid md:grid-cols-2 gap-6">
    <article class="card p-4">
      <h1 class="h1">Reto semanal: 7 conversaciones</h1>
      <p class="text-sm text-gray-600">Ranking amable por campus. ¡Suma solo conversaciones reales! Esta semana empieza el <span id="weekStart"></span>.</p>
      <ul id="score" class="mt-4 divide-y divide-gray-200 dark:divide-gray-700"></ul>
    </article>

    <article class="card p-4">
      <h2 class="font-semibold text-lg">Reportar (staff)</h2>
      <div class="grid gap-2">
        <select id="campus" class="rounded border-gray-300 dark:border-gray-700">
          <option>Medellín</option>
          <option>Bogotá</option>
          <option>Cali</option>
          <option>Otros</option>
        </select>
        <input id="amount" type="number" min="1" value="1" class="rounded border-gray-300 dark:border-gray-700" />
        <input id="code" type="password" placeholder="Código del campus" class="rounded border-gray-300 dark:border-gray-700" />
        <button id="btn" class="btn-primary">Sumar</button>
        <p class="text-xs text-gray-500">Solicita tu código privado al equipo central.</p>
      </div>
    </article>
  </section>

  <script nonce={cspNonce}>
    async function loadScore() {
      const res = await fetch('/api/campus/reto/score');
      const { rows, weekStart } = await res.json();
      document.getElementById('weekStart').textContent = new Date(weekStart).toLocaleDateString('es-CO');
      const ul = document.getElementById('score');
      ul.innerHTML = '';
      rows.sort((a,b)=> (b.sum||0)-(a.sum||0)).forEach((r,i)=>{
        const li = document.createElement('li');
        li.className = 'py-3 flex items-center justify-between';
        li.innerHTML = `<div class="flex items-center gap-3"><span class="text-lg">${i+1}.</span><strong>${r.campus}</strong></div><div class="text-lg">${r.sum||0}</div>`;
        ul.appendChild(li);
      });
    }
    loadScore();

    document.getElementById('btn').onclick = async () => {
      const campus = document.getElementById('campus').value;
      const amount = Number(document.getElementById('amount').value||1);
      const code = document.getElementById('code').value;
      await fetch('/api/campus/reto/add', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ campus, amount, code }) });
      loadScore();
    };
  </script>
</BaseLayout>
