---
import BaseLayout from '@layouts/BaseLayout.astro';

const token = Astro.url.searchParams.get('token') ?? '';
---

<BaseLayout title="Cumbre 2026 Manual | Ministerio Maná" description="Formulario manual para pagos físicos.">
  <section class="py-16 px-4 md:px-8">
    <div class="max-w-4xl mx-auto space-y-10">
      <div class="bg-white/5 border border-white/10 rounded-3xl p-8">
        <h1 class="text-2xl font-bold text-white">Cumbre 2026 - Registro Manual</h1>
        <p class="text-white/60 mt-2">Usa este formulario para pagos físicos en iglesias.</p>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-3xl p-8">
        <h2 class="text-xl font-semibold text-white mb-4">Crear reserva manual</h2>
        <form id="manual-booking-form" method="POST" action="/api/cumbre2026/manual/submit" class="space-y-6">
          <input type="hidden" name="token" value={token} />
          <input type="hidden" name="participants" id="participants-json" value="[]" />

          <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Nombre responsable</label>
              <input name="contactName" required class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Nombre completo" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Email</label>
              <input type="email" name="email" required class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="correo@email.com" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Teléfono</label>
              <input name="phone" required class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="3000000000" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Tipo documento</label>
              <select name="documentType" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white">
                <option value="">Selecciona</option>
                <option value="CC">CC</option>
                <option value="CE">CE</option>
                <option value="NIT">NIT</option>
                <option value="TI">TI</option>
                <option value="PAS">Pasaporte</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Número documento</label>
              <input name="documentNumber" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Documento" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">País</label>
              <input name="country" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Colombia" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Ciudad</label>
              <input name="city" required class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Ciudad" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Iglesia / Sede</label>
              <input name="church" required class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Iglesia / Sede" />
            </div>
            <div>
              <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Grupo país</label>
              <select name="countryGroup" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white">
                <option value="CO" selected>Colombia</option>
                <option value="INT">Internacional</option>
              </select>
            </div>
          </div>

          <div class="border-t border-white/10 pt-6">
            <h3 class="text-white font-semibold mb-3">Participantes</h3>
            <div class="grid gap-3 md:grid-cols-4">
              <input id="p-name" class="rounded-xl bg-black/20 border border-white/10 px-3 py-2 text-white" placeholder="Nombre" />
              <input id="p-age" type="number" class="rounded-xl bg-black/20 border border-white/10 px-3 py-2 text-white" placeholder="Edad" />
              <select id="p-lodging" class="rounded-xl bg-black/20 border border-white/10 px-3 py-2 text-white">
                <option value="yes">Con alojamiento</option>
                <option value="no">Sin alojamiento</option>
              </select>
              <input id="p-rel" class="rounded-xl bg-black/20 border border-white/10 px-3 py-2 text-white" placeholder="Relación" />
            </div>
            <button type="button" id="add-participant" class="mt-3 px-4 py-2 rounded-xl bg-brand-teal text-white">Agregar participante</button>
            <ul id="participants-list" class="mt-4 text-sm text-white/70 space-y-1"></ul>
          </div>

          <div class="border-t border-white/10 pt-6">
            <h3 class="text-white font-semibold mb-3">Pago</h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Opción de pago</label>
                <select name="paymentOption" id="payment-option" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white">
                  <option value="FULL">Pago completo</option>
                  <option value="DEPOSIT">Reserva 50%</option>
                  <option value="INSTALLMENTS">Cuotas</option>
                </select>
              </div>
              <div id="frequency-wrapper" class="hidden">
                <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Frecuencia cuotas</label>
                <select name="frequency" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white">
                  <option value="MONTHLY">Mensual</option>
                  <option value="BIWEEKLY">Quincenal</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Valor pagado hoy</label>
                <input name="paymentAmount" type="number" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="0" />
              </div>
              <div>
                <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Método de pago</label>
                <input name="paymentMethod" class="w-full rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Efectivo / Transferencia" />
              </div>
            </div>
          </div>

          <button type="submit" class="mt-4 px-6 py-3 rounded-xl bg-white text-brand-dark font-semibold">Crear reserva</button>
          <p id="manual-status" class="text-sm text-white/60 mt-3"></p>
        </form>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-3xl p-8">
        <h2 class="text-xl font-semibold text-white mb-4">Registrar abono manual</h2>
        <form id="manual-payment-form" method="POST" action="/api/cumbre2026/manual/payment" class="space-y-4">
          <input type="hidden" name="token" value={token} />
          <div class="grid gap-4 md:grid-cols-3">
            <input name="bookingId" required class="rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Booking ID" />
            <input name="amount" type="number" required class="rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Monto" />
            <input name="paymentMethod" class="rounded-xl bg-black/20 border border-white/10 px-4 py-3 text-white" placeholder="Método (efectivo...)" />
          </div>
          <button type="submit" class="px-6 py-3 rounded-xl bg-brand-teal text-white font-semibold">Registrar abono</button>
          <p id="payment-status" class="text-sm text-white/60 mt-3"></p>
        </form>
      </div>
    </div>
  </section>

  <script type="module">
    const participants = [];
    const list = document.getElementById('participants-list');
    const input = document.getElementById('participants-json');

    document.getElementById('add-participant')?.addEventListener('click', () => {
      const name = document.getElementById('p-name').value.trim();
      const age = Number(document.getElementById('p-age').value || 0);
      const lodging = document.getElementById('p-lodging').value;
      const relationship = document.getElementById('p-rel').value.trim();
      if (!name) return;
      participants.push({ fullName: name, age, lodging, relationship });
      input.value = JSON.stringify(participants);
      list.innerHTML = participants
        .map((p) => `<li>${p.fullName} • ${p.age || '-'} • ${p.lodging === 'yes' ? 'Con alojamiento' : 'Sin alojamiento'}</li>`)
        .join('');
      document.getElementById('p-name').value = '';
      document.getElementById('p-age').value = '';
      document.getElementById('p-rel').value = '';
    });

    const paymentOption = document.getElementById('payment-option');
    const frequencyWrapper = document.getElementById('frequency-wrapper');
    paymentOption?.addEventListener('change', (e) => {
      const value = e.target.value;
      if (value === 'INSTALLMENTS') {
        frequencyWrapper.classList.remove('hidden');
      } else {
        frequencyWrapper.classList.add('hidden');
      }
    });

    document.getElementById('manual-booking-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const status = document.getElementById('manual-status');
      status.textContent = 'Enviando...';
      const res = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
      });
      const payload = await res.json();
      if (payload?.ok) {
        status.textContent = `Reserva creada: ${payload.bookingId}`;
      } else {
        status.textContent = payload?.error || 'No se pudo crear la reserva';
      }
    });

    document.getElementById('manual-payment-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const status = document.getElementById('payment-status');
      status.textContent = 'Registrando...';
      const res = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
      });
      const payload = await res.json();
      if (payload?.ok) {
        status.textContent = `Abono registrado: ${payload.reference}`;
      } else {
        status.textContent = payload?.error || 'No se pudo registrar el abono';
      }
    });
  </script>
</BaseLayout>
