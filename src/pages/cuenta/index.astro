---
import BaseLayout from '@layouts/BaseLayout.astro';
---

<BaseLayout title="Mi cuenta | Ministerio Maná" description="Gestiona tu perfil, pagos y cuotas.">
  <section class="py-16 px-4 md:px-8">
    <div class="max-w-6xl mx-auto space-y-10">
      <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <p class="text-brand-teal text-xs uppercase tracking-[0.35em]">Cuenta Maná</p>
          <h1 class="text-3xl md:text-4xl font-bold text-white">Mi Cuenta</h1>
        </div>
        <button id="btn-logout" class="px-4 py-2 rounded-lg border border-white/10 text-white/70 hover:text-white hover:border-white/30 transition-all">
          Cerrar sesión
        </button>
      </header>

      <div id="account-loading" class="text-center text-white/60 py-12">Cargando tu cuenta...</div>
      <div id="account-error" class="hidden text-center text-red-300 py-12">No pudimos cargar tu cuenta.</div>

      <div id="account-content" class="hidden space-y-8">
        <div class="grid md:grid-cols-[1.2fr_1fr] gap-6">
          <div class="bg-white/5 border border-white/10 rounded-3xl p-6 space-y-4">
            <h2 class="text-xl font-bold text-white">Perfil</h2>
            <div class="grid gap-4">
              <div>
                <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Nombre</label>
                <input type="text" id="profile-name" class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white outline-none focus:border-brand-teal focus:ring-1 focus:ring-brand-teal transition-all">
              </div>
              <div>
                <label class="block text-xs font-bold text-white/60 mb-2 uppercase tracking-wider">Correo</label>
                <input type="email" id="profile-email" disabled class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 text-white/60">
              </div>
              <button id="btn-save-profile" class="bg-brand-teal text-white px-6 py-3 rounded-xl font-bold hover:brightness-110 transition-all">
                Guardar cambios
              </button>
              <p id="profile-status" class="text-sm text-white/60"></p>
            </div>
          </div>

          <div class="bg-white/5 border border-white/10 rounded-3xl p-6 space-y-4">
            <h2 class="text-xl font-bold text-white">Soporte</h2>
            <p class="text-white/60 text-sm">¿Necesitas ayuda con pagos o cuotas? Escríbenos por WhatsApp.</p>
            <a href="https://wa.me/573148297534" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 transition-all">
              Contactar soporte
            </a>
            <p class="text-xs text-white/40">Horario de atención: Lun–Vie, 8:00–18:00 (COL).</p>
          </div>
        </div>

        <div class="bg-white/5 border border-white/10 rounded-3xl p-6 space-y-4">
          <h2 class="text-xl font-bold text-white">Cumbre Mundial 2026</h2>
          <div id="bookings-list" class="grid md:grid-cols-2 gap-4"></div>
          <p id="bookings-empty" class="text-sm text-white/50 hidden">No encontramos reservas asociadas a tu cuenta.</p>
        </div>

        <div class="bg-white/5 border border-white/10 rounded-3xl p-6 space-y-4">
          <h2 class="text-xl font-bold text-white">Planes de cuotas</h2>
          <div id="plans-list" class="grid md:grid-cols-2 gap-4"></div>
          <p id="plans-empty" class="text-sm text-white/50 hidden">No tienes planes de cuotas activos.</p>
        </div>

        <div class="bg-white/5 border border-white/10 rounded-3xl p-6 space-y-4">
          <h2 class="text-xl font-bold text-white">Historial de pagos</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-white/70">
              <thead class="text-xs uppercase text-white/40 border-b border-white/10">
                <tr>
                  <th class="text-left py-2 pr-4">Fecha</th>
                  <th class="text-left py-2 pr-4">Referencia</th>
                  <th class="text-left py-2 pr-4">Proveedor</th>
                  <th class="text-left py-2 pr-4">Monto</th>
                  <th class="text-left py-2 pr-4">Estado</th>
                </tr>
              </thead>
              <tbody id="payments-table" class="divide-y divide-white/10"></tbody>
            </table>
          </div>
          <p id="payments-empty" class="text-sm text-white/50 hidden">Aún no hay pagos registrados.</p>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    import { getSupabaseBrowserClient } from '@lib/supabaseBrowser';

    const loadingEl = document.getElementById('account-loading');
    const errorEl = document.getElementById('account-error');
    const contentEl = document.getElementById('account-content');
    const profileName = document.getElementById('profile-name');
    const profileEmail = document.getElementById('profile-email');
    const profileStatus = document.getElementById('profile-status');
    const bookingsList = document.getElementById('bookings-list');
    const bookingsEmpty = document.getElementById('bookings-empty');
    const plansList = document.getElementById('plans-list');
    const plansEmpty = document.getElementById('plans-empty');
    const paymentsTable = document.getElementById('payments-table');
    const paymentsEmpty = document.getElementById('payments-empty');
    const logoutBtn = document.getElementById('btn-logout');
    const saveProfileBtn = document.getElementById('btn-save-profile');

    const supabase = getSupabaseBrowserClient();

    function formatCurrency(value, currency) {
      if (!currency) return value;
      if (currency === 'COP') {
        return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(value || 0);
      }
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value || 0);
    }

    function formatDate(value) {
      if (!value) return '-';
      const date = new Date(value);
      return date.toLocaleDateString('es-CO', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function frequencyLabel(value) {
      return value === 'BIWEEKLY' ? 'Quincenal' : 'Mensual';
    }

    async function loadAccount() {
      try {
        const { data: sessionData } = await supabase.auth.getSession();
        const token = sessionData.session?.access_token;
        if (!token) {
          window.location.href = '/cuenta/ingresar';
          return;
        }

        const { data: userData } = await supabase.auth.getUser();
        const user = userData.user;

        const res = await fetch('/api/cuenta/resumen', {
          headers: { Authorization: `Bearer ${token}` },
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || 'No se pudo cargar');

        profileName.value = payload.user?.fullName || user?.user_metadata?.full_name || '';
        profileEmail.value = payload.user?.email || user?.email || '';

        renderBookings(payload.bookings || []);
        renderPlans(payload.plans || [], payload.bookings || []);
        renderPayments(payload.payments || []);

        loadingEl.classList.add('hidden');
        contentEl.classList.remove('hidden');
      } catch (err) {
        console.error(err);
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
      }
    }

    function renderBookings(bookings) {
      bookingsList.innerHTML = '';
      if (!bookings.length) {
        bookingsEmpty.classList.remove('hidden');
        return;
      }
      bookingsEmpty.classList.add('hidden');
      bookings.forEach((booking) => {
        const card = document.createElement('div');
        card.className = 'bg-black/20 border border-white/10 rounded-2xl p-4 space-y-2';
        card.innerHTML = `
          <div class="flex justify-between text-white">
            <span class="font-bold">Reserva #${booking.id.slice(0, 8).toUpperCase()}</span>
            <span class="text-xs uppercase tracking-wider text-white/50">${booking.status}</span>
          </div>
          <p class="text-sm text-white/70">Total: ${formatCurrency(booking.total_amount, booking.currency)}</p>
          <p class="text-sm text-white/70">Pagado: ${formatCurrency(booking.total_paid, booking.currency)}</p>
        `;
        bookingsList.appendChild(card);
      });
    }

    function renderPlans(plans, bookings) {
      plansList.innerHTML = '';
      if (!plans.length) {
        plansEmpty.classList.remove('hidden');
        return;
      }
      plansEmpty.classList.add('hidden');
      plans.forEach((plan) => {
        const booking = bookings.find((item) => item.id === plan.booking_id);
        const card = document.createElement('div');
        card.className = 'bg-black/20 border border-white/10 rounded-2xl p-4 space-y-3';
        const statusLabel = plan.status === 'PAUSED' ? 'Pausado' : plan.status === 'COMPLETED' ? 'Completado' : 'Activo';
        const actionLabel = plan.status === 'PAUSED' ? 'Reactivar' : 'Pausar';
        card.innerHTML = `
          <div class="flex justify-between text-white">
            <span class="font-bold">${frequencyLabel(plan.frequency)} · ${formatCurrency(plan.installment_amount, plan.currency)}</span>
            <span class="text-xs uppercase tracking-wider text-white/50">${statusLabel}</span>
          </div>
          <p class="text-sm text-white/70">Reserva: ${booking ? booking.id.slice(0, 8).toUpperCase() : '-'}</p>
          <p class="text-sm text-white/70">Próximo cobro: ${plan.next_due_date || 'Por confirmar'}</p>
          <button class="plan-action px-3 py-2 rounded-lg border border-white/20 text-white/70 hover:text-white hover:border-white/40 transition-all" data-plan="${plan.id}" data-action="${plan.status === 'PAUSED' ? 'resume' : 'pause'}">
            ${actionLabel}
          </button>
        `;
        plansList.appendChild(card);
      });
    }

    function renderPayments(payments) {
      paymentsTable.innerHTML = '';
      if (!payments.length) {
        paymentsEmpty.classList.remove('hidden');
        return;
      }
      paymentsEmpty.classList.add('hidden');
      payments.forEach((payment) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="py-2 pr-4">${formatDate(payment.created_at)}</td>
          <td class="py-2 pr-4">${payment.reference || '-'}</td>
          <td class="py-2 pr-4">${payment.provider?.toUpperCase() || '-'}</td>
          <td class="py-2 pr-4">${formatCurrency(payment.amount, payment.currency)}</td>
          <td class="py-2 pr-4">${payment.status || '-'}</td>
        `;
        paymentsTable.appendChild(row);
      });
    }

    async function updateProfile() {
      profileStatus.textContent = 'Guardando...';
      try {
        const { data: sessionData } = await supabase.auth.getSession();
        const token = sessionData.session?.access_token;
        const res = await fetch('/api/cuenta/perfil', {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ fullName: profileName.value.trim() }),
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || 'No se pudo actualizar');
        profileStatus.textContent = 'Perfil actualizado.';
      } catch (err) {
        console.error(err);
        profileStatus.textContent = 'No pudimos actualizar el perfil.';
      }
    }

    async function handlePlanAction(event) {
      const target = event.target.closest('.plan-action');
      if (!target) return;
      const planId = target.dataset.plan;
      const action = target.dataset.action;
      const endpoint = action === 'resume' ? '/api/cuenta/planes/resume' : '/api/cuenta/planes/pause';

      try {
        const { data: sessionData } = await supabase.auth.getSession();
        const token = sessionData.session?.access_token;
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ planId }),
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || 'No se pudo actualizar');
        await loadAccount();
      } catch (err) {
        console.error(err);
        alert('No pudimos actualizar tu plan. Intenta nuevamente.');
      }
    }

    logoutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/cuenta/ingresar';
    });

    saveProfileBtn?.addEventListener('click', updateProfile);
    plansList?.addEventListener('click', handlePlanAction);

    loadAccount();
  </script>
</BaseLayout>
